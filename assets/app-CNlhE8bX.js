var st=Object.defineProperty;var ot=(o,t,e)=>t in o?st(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var a=(o,t,e)=>ot(o,typeof t!="symbol"?t+"":t,e);const nt=o=>o.toISOString().slice(0,19).replace("T"," "),v=(...o)=>{},rt=(...o)=>{{const t=new Date,e=nt(t),i=String(t.getMilliseconds()).padStart(3,"0");console.log(`[${e}.${i}]`,...o)}};class at{constructor(t){this.mHead=null,this.mTail=null,this.mQueCnt=0,this.mTask=t}send(t){t.setNext(null),this.mTail&&this.mTail.setNext(t),this.mTail=t,this.mHead===null&&(this.mHead=t),this.mQueCnt++}get(){let t=null;return this.mHead&&(t=this.mHead,this.mHead=this.mHead.getNext(),this.mQueCnt--,this.mQueCnt===0&&(this.mTail=null)),t}wait(){for(;;){if(this.isReceived())return this.get();new Promise(t=>setTimeout(t,100))}}isReceived(){return this.mHead!==null}}class L{constructor(t){this.mQueue=new at(t)}getMessage(){let t=null;return this.mQueue&&(t=this.mQueue.get()),t}peekMessage(){let t=null;return this.mQueue&&(t=this.mQueue.get(),t&&v(`mQueue->get(): ${t.getId()}`)),t}sendMessage(t){this.mQueue&&(this.mQueue.send(t),t&&v(`mQueue->send: ${t.getId()}`))}}const R=class R{constructor(){this.mArrCommandSet=[],this.mIndex=0}clear(){this.mArrCommandSet=[]}insertCommandSet(t){for(let e=0;e<this.mArrCommandSet.length;e++){const i=this.mArrCommandSet[e];if(i.SNO===t.SNO&&i.CNO===t.CNO)return this.mArrCommandSet.splice(e,1,t),R.UPDATE;if(i.SNO===t.PRVSNO&&i.CNO===t.PRVCNO)return this.mArrCommandSet.splice(e+1,0,t),R.INSERT}return this.mArrCommandSet.push(t),R.ADD}getCommandSet(){return this.mIndex<this.mArrCommandSet.length?this.mArrCommandSet[this.mIndex]:null}searchCommandSet(t,e){for(let i=0;i<this.mArrCommandSet.length;i++){const s=this.mArrCommandSet[i];if(s.SNO===t&&s.CNO===e)return this.mIndex=i,!0}return!1}getRecordCount(){return this.mArrCommandSet.length}moveFirst(){this.mIndex=0}moveNext(){this.mIndex++}};a(R,"INSERT",0),a(R,"UPDATE",1),a(R,"ADD",2);let D=R;class n{constructor(t=0,e=null,i=0){this.mId=t,this.mDataLen=i,this.mData=e,this.mNext=null}getTime(){return this.mTime}getId(){return this.mId}getData(){return this.mData}getDataLength(){return this.mDataLen}getNext(){return this.mNext}setNext(t){this.mNext=t}}a(n,"CMD_INIT",17),a(n,"CMD_START",18),a(n,"CMD_GET_CALIBINFO",20),a(n,"CMD_SET_SOROTINFO",21),a(n,"CMD_START_CALIB",22),a(n,"CMD_SET_INDIVIDUAL",23),a(n,"CMD_GET_SOROTINFO",33),a(n,"CMD_CHANGE_SCENARIO",49),a(n,"CMD_INSERT_SCENARIO",50),a(n,"CMD_CLEAR_SCENARIO",51),a(n,"CMD_STOP",52),a(n,"CMD_SET_SCENARIOINFO",53),a(n,"CMD_SYNC",54),a(n,"CMD_INSERT_SUB_LIST",55),a(n,"CMD_INSERT_SCN_LIST",56),a(n,"CMD_COMPLETE_BT",144),a(n,"CMD_CORRECT_COORDINF",145),a(n,"CMD_SONARSENSOR",146),a(n,"ERR_OK",0),a(n,"ERR_EXECCMD",1),a(n,"ERR_SCNRONO",2),a(n,"ERR_CHGSCNRO",3),a(n,"ERR_STATUS",33),a(n,"ERR_COMMAND",65),a(n,"ERR_DATALEN",66),a(n,"ERR_PARAM",67),a(n,"ERR_SEQNO",68),a(n,"ERR_CHECKSUM",69),a(n,"ERR_HARDWARE",97),a(n,"ERR_LOGICAL",145),a(n,"ERR_FATAL",153);const S=class S extends L{constructor(){super(),this.mScenario=new D,this.mIsSync=!1,this.mSubScenarioList=[],this.mSubScnListIndex=0,this.mScenarioNoList=[],this.mScnNoListIndex=0}start(){console.log("ScenarioCtrl start")}run(){let t=this.peekMessage();if(t!==null){switch(v(`ScenarioCtrl run. :${t.getId()}`),t.getId()){case n.CMD_CLEAR_SCENARIO:console.log("CMD_CLEAR_SCENARIO"),this.clearScenario(t);break;case n.CMD_INSERT_SCENARIO:console.log("CMD_INSERT_SCENARIO"),this.insertScenario(t);break;case n.CMD_START_CALIB:console.log("CMD_START_CALIB"),this.preStartScenario();break;case n.CMD_START:console.log("CMD_START"),this.nextScenario(t,!0);break;case n.CMD_STOP:console.log("CMD_STOP"),this.stopScenario(t);break;case n.CMD_CHANGE_SCENARIO:console.log("CMD_CHANGE_SCENARIO"),this.nextScenario(t,!1);break;case n.CMD_SYNC:console.log("CMD_SYNC"),this.mIsSync=!0;break;case n.CMD_INSERT_SUB_LIST:console.log("CMD_INSERT_SUB_LIST"),this.insertSubScenarioList();break;case n.CMD_INSERT_SCN_LIST:console.log("CMD_INSERT_SCN_LIST"),this.insertScenarioNoList(t);break}t=null}}clearScenario(t){this.mScenario=new D}insertScenario(t){let e=t.getData();this.mScenario.insertCommandSet(e),console.log(`ScenaIN ${e.SNO} ${e.CNO}`)}insertSubScenarioList(){this.mSubScenarioList.push(this.mScenario),this.mScenario=new D}insertScenarioNoList(t){console.log("insertScenarioNoList 開始");let e=t.getData(),i=t.getDataLength()-RCVHEADERSIZE;for(let s=0;s<i;s++)this.mScenarioNoList.push(e[s]),console.log(`ScnNo:${s} ${e[s]}`);console.log("insertScenarioNoList 完了")}preStartScenario(){console.log("preStartScenario 開始");let t={},e;this.mScenario=this.mSubScenarioList[0],this.mScenario&&(t=this.mScenario.getCommandSet(),console.log(`${this.constructor.name} ${t.SNO} ${t.CNO}`),e=new n(n.CMD_CHANGE_SCENARIO,t),window.RUNCONTROL.sendMessage(e),e=new n(n.CMD_CHANGE_SCENARIO,t),window.NAVIGATOR.sendMessage(e),console.log("preStartScenario 完了"))}stopScenario(t){}nextScenario(t,e){let i={},s,r=t.getData();if(e){if(r[0]===0&&r[1]===0)this.mScenario.moveFirst();else if(!this.mScenario.searchCommandSet(r[0],r[1])){console.log(`ScenaNG ${r[0]} ${r[1]}`);return}}else if(r[0]===1)this.mScenario.moveNext();else if(!this.mScenario.searchCommandSet(r[1],r[2])){console.log(`ScenaNG ${r[0]} ${r[1]}`);return}if(rt("ScenarioControl::nextScenario 1"),this.IsEndScenario())if(this.mScnNoListIndex++,this.mScnNoListIndex<this.mScenarioNoList.length)this.mScenario=this.mSubScenarioList[this.mScenarioNoList[this.mScnNoListIndex]],this.mScenario.moveFirst(),console.log(`ScnNo:${this.mScenarioNoList[this.mScnNoListIndex]}`);else{COMMANDDISPATCHER.sendResponse(t,n.ERR_OK);return}i=this.mScenario.getCommandSet(),console.log(`SNO:${i.SNO} CNO:${i.CNO}`);try{const h={SNO:this.mScenario.getCommandSet().SNO,CNO:this.mScenario.getCommandSet().CNO,timestamp:Date.now(),robot:JSON.parse(JSON.stringify(window.robot)),isDraw:!1,commandSet:JSON.parse(JSON.stringify(i))};Array.isArray(window.SCENARIO_MARKERS)||(window.SCENARIO_MARKERS=[]),window.SCENARIO_MARKERS.push(h)}catch(h){console.warn("Failed to capture marker",h)}i.CoordCorrectInfo.ACAF>0&&(s=new n(n.CMD_CORRECT_COORDINF,i.CoordCorrectInfo),window.STATUSMONITOR.sendMessage(s));let c=S.OFF;i.RunInfo.SONAR&&(c=S.ON),s=new n(n.CMD_SONARSENSOR,c),window.STATUSMONITOR.sendMessage(s),s=new n(n.CMD_CHANGE_SCENARIO,i),window.RUNCONTROL.sendMessage(s),s=new n(n.CMD_CHANGE_SCENARIO,i),window.NAVIGATOR.sendMessage(s),e&&(window.RUNCONTROL.ArmOnly=!1)}IsEndScenario(){return this.mScenario.getCommandSet().SNO===0&&this.mScenario.getCommandSet().CNO===0}static getInstance(){return S.mSingleton==null&&(S.mSingleton=new S),S.mSingleton}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};a(S,"mSingleton",null),a(S,"OFF",!1),a(S,"ON",!0);let E=S;window.SCENARIOCONTROL=E.getInstance();const T=class T extends L{constructor(t,e){super(),this.colorMonitor=t,this.hwMonitor=e,this.msecCount=0}start(){console.log("TaskStsMon run"),this.hwMonitor.resetDevice()}run(){let t=this.peekMessage();if(t!==null){switch(t.getId()){case n.CMD_CORRECT_COORDINF:window.HWMONITOR.correctCoordinateInfo(t.getData());break;case n.CMD_SONARSENSOR:window.HWMONITOR.setSonarSwitch(t.getData());break}t=null}this.colorMonitor.read(),this.msecCount===0?(this.msecCount=1,this.hwMonitor.read()):this.msecCount=0}stop(){}static getInstance(){return T.mSingleton==null&&(T.mSingleton=new T(window.COLORMONITOR,window.HWMONITOR)),T.mSingleton}resetMotor(){this.hwMonitor.resetDevice(!0)}getColorInfo(t){Object.assign(t,this.colorMonitor.getColorInfo())}getBodyInfo(t){Object.assign(t,this.hwMonitor.getBodyInfo())}getCoordinateInfo(t){try{Object.assign(t,this.hwMonitor.getCoordinateInfo())}catch(e){console.error(e)}}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};a(T,"mSingleton",null);let b=T;class f{constructor(t){this.name=t,this.fg_motor=null,this.pwm=0,this.count=0}setUp(t,e){console.log(`motor setup: ${e}`),console.log(e==="left"?`motor_setup left: ${e}`:`motor_setup other: ${e}`)}getPWM(){return isNaN(this.pwm)?0:this.pwm}setPWM(t){this.pwm=t,this.updateLeftPowerDisplay()}getCount(){let h=0,d=0;const w=this.getPWM();return d+=.1*(1*w-.5*d-.01*.1*Math.sign(d)-.01*.1),h+=.1*d,this.count+=h*window.robot.maxSpeed,this.count}reset(){return 0}updateLeftPowerDisplay(){window.formData.setValue(this.name,this.getPWM())}}a(f,"LEFT",0),a(f,"RIGHT",1),a(f,"MOTOR_NUM",2);const ct=20,_={WHITE:0,GRAY:1,BLACK:2,NONE:5};class ht{constructor(t,e=ct){a(this,"blueCount",0);this.port=t,this.blueCount=0,this.changeCount=e,this.changeRateArray=Array(e).fill(0),this.changeRateIndex=0,this.sumChangeRateArray=0,this.diffSumChangeRateAry=0,this.colorInfo={color:_.NONE,ColorSensorValue:0,diffValue:0,diffSumChangeRateAry:0,diffSumChangeRateAryLast:0}}getBrightness(){return robot.sensor.brightness}read(){const t=this.getBrightness();this.colorInfo.color=t<10?_.BLACK:t>60?_.WHITE:_.GRAY,this.colorInfo.ColorSensorValue=t,this.colorInfo.diffValue=this.getChangeRateWidth(t),this.colorInfo.diffSumChangeRateAryLast=this.colorInfo.diffSumChangeRateAry,this.colorInfo.diffSumChangeRateAry=this.diffSumChangeRateAry}getChangeRateWidth(t){this.changeRateArray[this.changeRateIndex%this.changeCount]=t,this.changeRateIndex++;const e=Math.min(this.changeRateIndex,this.changeCount),i=this.changeRateArray.slice(0,e),s=Math.max(...i),r=Math.min(...i),c=i.reduce((h,d)=>h+d,0);return this.diffSumChangeRateAry=this.sumChangeRateArray-c,this.sumChangeRateArray=c,s-r}getColorInfo(){return this.colorInfo}}class V{constructor(){this.x=0,this.y=0,this.distance=0,this.driveDirection=0,this.driveDirectionAve=0,this.driveDirectionAveLast=0,this.isObstacle=!1}}class U{constructor(t,e){this.motorL=t,this.motorR=e,this.resetDevice(),this.lastDistance=0,this.lastDriveDirection=0,this.spdSmplCnt=0,this.isCorrect={LEFT:!1,RIGHT:!1},this.beforeEncoderValue={LEFT:0,RIGHT:0},this.storedEncoder={LEFT:0,RIGHT:0},this.driveDirectionIdx=0,this.coordinate=new V,this.bodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0},this.drive_direction_cnt=window.config.robot.direction.drive_direction_cnt,this.driveDirectionAry=Array(window.drive_direction_cnt).fill(0),this.distanceDriveDirectionAry=Array(window.drive_direction_cnt).fill(0),this.speedBuf=Array(window.config.robot.speed.sample_num).fill(0),this.setWheelTransParam(window.config.robot.wheel.radius)}setWheelTransParam(t){this.wheelTransParam=2*Math.PI*t*100/100/360}resetDevice(t=!1){t&&(this.storedEncoder.LEFT+=this.motorL.getCount(),this.storedEncoder.RIGHT+=this.motorR.getCount()),this.motorL.reset(),this.motorR.reset(),this.coordinate=new V,this.bodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0}}setGyroOffSet(t){this.gyroOffSet=t}read(){let t=this.motorL.getCount(),e=this.motorR.getCount();this.bodyInfo.EncoderValue.LEFT-t>1e4&&(this.bodyInfo.EncoderValue.LEFT=0),this.bodyInfo.EncoderValue.RIGHT-e>1e4&&(this.bodyInfo.EncoderValue.RIGHT=0),this.calcCoordinates(this.storedEncoder.LEFT+t,this.storedEncoder.RIGHT+e),this.bodyInfo.EncoderValue.LEFT=t,this.bodyInfo.EncoderValue.RIGHT=e,this.getSpeed(),this.getDriveDirectionAve()}calcCoordinates(t,e){let i=new Array(f.MOTOR_NUM),s,r,c,h,d,w=new Array(f.MOTOR_NUM);w[f.LEFT]=t,w[f.RIGHT]=e,i[f.LEFT]=this.getMoterMoveDistance(this.beforeEncoderValue.LEFT,t),i[f.RIGHT]=this.getMoterMoveDistance(this.beforeEncoderValue.RIGHT,e),this.beforeEncoderValue.LEFT=t,this.beforeEncoderValue.RIGHT=e,!(i[f.LEFT]===0&&i[f.RIGHT]===0)&&(s=(i[f.LEFT]+i[f.RIGHT])/2,this.coordinate.distance+=s*window.config.robot.scale,i[f.LEFT]!==i[f.RIGHT]?(c=(i[f.LEFT]-i[f.RIGHT])/window.config.robot.wheel.interval,r=this.coordinate.driveDirection+c,r>2*Math.PI?r-=2*Math.PI:r<-2*Math.PI&&(r+=2*Math.PI),this.coordinate.driveDirection=r,h=2*s/c*Math.sin(c/2),d=-c/2+this.coordinate.driveDirection,this.coordinate.x-=h*Math.cos(d),this.coordinate.y+=h*Math.sin(d)):(this.coordinate.x-=s*Math.cos(this.coordinate.driveDirection),this.coordinate.y+=s*Math.sin(this.coordinate.driveDirection)))}getSpeed(){let t=0;this.speedBuf[this.spdSmplCnt]=(this.coordinate.distance-this.lastDistance)*1e3/window.STATUSMONITOR.TASK_PERIOD,this.spdSmplCnt++,this.spdSmplCnt>window.config.robot.speed.sample_num-1&&(this.spdSmplCnt=0);for(let i=0;i<window.config.robot.speed.sample_num;i++)t+=this.speedBuf[i];this.bodyInfo.RunSpeed=t/window.config.robot.speed.sample_num;let e=(this.coordinate.driveDirection-this.lastDriveDirection)*100;e>500||e<-500?this.bodyInfo.TurnSpeed=(this.coordinate.driveDirection+(2*Math.PI-this.lastDriveDirection))*100:this.bodyInfo.TurnSpeed=(this.coordinate.driveDirection-this.lastDriveDirection)*100,this.lastDistance=this.coordinate.distance,this.lastDriveDirection=this.coordinate.driveDirection}getMoterMoveDistance(t,e){return(e-t)*this.wheelTransParam}getDriveDirectionAve(){this.coordinate.distance-this.distanceDriveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]>3&&(this.driveDirectionIdx%this.drive_direction_cnt===0&&(this.coordinate.driveDirectionAveLast=this.coordinate.driveDirectionAve),this.driveDirectionIdx++,this.distanceDriveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]=this.coordinate.distance,this.driveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]=this.coordinate.driveDirection,this.coordinate.driveDirectionAve=this.dAverage(this.driveDirectionAry,this.drive_direction_cnt))}dAverage(t,e){let i=0;for(let s=0;s<e;s++)i+=t[s];return i/e}getBodyInfo(){return this.bodyInfo}getCoordinateInfo(){return this.coordinate}correctCoordinateInfo(t){(t.ACAF&1)===1&&(this.coordinate.x=t.CAPX),(t.ACAF&2)===2&&(this.coordinate.y=t.CAPY),(t.ACAF&4)===4&&(this.coordinate.driveDirection=t.CAPR*Math.PI/180)}setSonarSwitch(t){this.bodyInfo.sonarOn=t,this.bodyInfo.SonarValue=0,this.coordinate.IsObstacle=!1}}const lt="leftPower",dt="rightPower",l=class l extends L{constructor(t){super(),this.taskId=t,this.isSonarTarget=!1,l.mStatus=l.Initial,l.mArmMotor=new f("c"),l.mRightMotor=new f(dt),l.mLeftMotor=new f(lt),l.mHWMonitor=new U(l.mLeftMotor,l.mRightMotor),window.COLORMONITOR=l.getColorMonitor(),window.HWMONITOR=l.getHWMonitor(),window.STATUSMONITOR=b.getInstance(),window.ARMMOTOR=l.getArmMotor(),window.RIGHTMOTOR=l.getRightMotor(),window.LEFTMOTOR=l.getLeftMotor()}async run(){let t=!1;console.log("wait sorot getMessage");let e;for(;;){if(e=this.getMessage(),e==null){await new Promise(i=>setTimeout(i,4));continue}switch(console.log(`SorotRcv: ${e.getId()}`),e.getId()){case n.CMD_INIT:console.log("Message.CMD_INIT"),this.setStatus(l.Idle);break;case n.CMD_SET_SOROTINFO:console.log("Message.CMD_SET_SOROTINFO"),this.setRunControlParam(e);break;case n.CMD_SET_INDIVIDUAL:console.log("Message.CMD_SET_INDIVIDUAL"),this.setIndividualParam(e);break;case n.CMD_START_CALIB:console.log("Message.CMD_START_CALIB"),await this.doCalibration(e),this.getCalibrationInfo(e),this.setStatus(l.Ready);break;case n.CMD_GET_CALIBINFO:console.log("Message.CMD_GET_CALIBINFO"),this.getCalibrationInfo(e);break;case n.CMD_START:console.log("Message.CMD_START"),this.setStatus(l.Running),this.startRun(e),t=!0;break}if(e=null,t)break}}initialize(){l.mArmMotor.setPWM(30),setTimeout(()=>{l.mArmMotor.setPWM(0),l.mArmMotor.reset()},600)}async doCalibration(t){window.RUNCONTROL.ArmOnly=!0,window.RUNCONTROL.start(),console.log("START CALIB");const e=gBlack,i=gWhite;console.log(gBlack);const s=Math.floor((e+i)/2);this.mCalInfo={mCalBlack:e,mCalGray:s,mCalWhite:i,mGyroOffset:0},window.RUNCONTROL.setCalibrationInfo(this.mCalInfo),window.NAVIGATOR.setCalibrationInfo(this.mCalInfo);const r=new n(t.getId(),t.getData(),t.getDataLength());window.SCENARIOCONTROL.sendMessage(r)}getCalibrationInfo(t){}startRun(t){const e=new n(t.getId(),t.getData(),t.getDataLength());window.STATUSMONITOR.start(),window.NAVIGATOR.start(),window.SCENARIOCONTROL.sendMessage(e)}setRunControlParam(t){const e=t.getData();A_D=e.A_D,A_R=e.A_R,K_F=[e.K_F0,e.K_F1,e.K_F2,e.K_F3],K_I=e.K_I,K_PHIDOT=e.K_PHIDOT,K_THETADOT=e.K_THETADOT}setIndividualParam(t){}setStatus(t){l.mStatus=t}getStatus(){return l.mStatus}static getColorMonitor(){return l.mColorMonitor}static getArmMotor(){return l.mArmMotor}static getRightMotor(){return l.mRightMotor}static getLeftMotor(){return l.mLeftMotor}static getHWMonitor(){return l.mHWMonitor}static getCalibration(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};a(l,"Initial",0),a(l,"Idle",1),a(l,"Downloaded",2),a(l,"Calibrating",3),a(l,"Ready",4),a(l,"Running",5),a(l,"Goal",6),a(l,"Retire",7),a(l,"mLCD",{}),a(l,"mArmMotor"),a(l,"mRightMotor"),a(l,"mLeftMotor"),a(l,"mColorMonitor",new ht("C")),a(l,"mHWMonitor"),a(l,"mStatus");let I=l;const C=class C{constructor(){this.m_LostCnt=0,this.m_pCaribInfo}IsLost(){return!1}GetStatus(){let t=C.JS_CONTINUE;return this.IsLost()?t=C.JS_LOST:this.IsChange()&&(t=C.JS_NEXT),t}IsChange(){return!1}SetCaribrationInfo(t){this.m_pCaribInfo=t}};a(C,"JS_CONTINUE",0),a(C,"JS_LOST",1),a(C,"JS_NEXT",2),a(C,"JS_RETURN",3);let g=C;typeof window>"u"&&(global.window=global);class ut extends g{constructor(){super(),this.m_PassageTime=0,this.m_startTime=Date.now(),this.m_clock={now:()=>Date.now()-this.m_startTime,reset:()=>{this.m_startTime=Date.now()}}}IsChange(){return this.m_clock.now()>this.m_PassageTime}Init(t){this.m_PassageTime=t.SwitchInfo.SCT}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class mt extends g{constructor(){super(),this.m_VarType=0}IsChange(){let t=!1;switch(this.m_VarType){case 0:t=!0;break;case 1:t=window.SOROT.getIsSwitchFlg();break}return t}Init(t){this.m_VarType=t.SwitchInfo.SCV}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class ft extends g{constructor(){super(),this.m_naname=!1,this.m_targetColor=null}IsChange(){return this.getColorInfo().color===this.m_targetColor}Init(t){this.m_naname=t.RunInfo.NOBLNCE===1,this.m_targetColor=t.SwitchInfo.SCC}getColorInfo(){const t={};return window.STATUSMONITOR.getColorInfo(t),t}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class gt extends g{constructor(){super(),this.m_PreDiff=0,this.m_TargetDir=0}IsChange(){let t;const e={};window.STATUSMONITOR.getCoordinateInfo(e),t=this.m_TargetDir-e.driveDirection;const i=this.m_PreDiff*t<=0;return this.m_PreDiff=t,i}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_TargetDir=t.SwitchInfo.SCR*(Math.PI/180)+e.driveDirection,this.m_PreDiff=this.m_TargetDir-e.driveDirection}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class wt extends g{constructor(){super(),this.m_startDistance=0,this.preDistance=0,this.m_distance=0}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_startDistance=e.distance,this.preDistance=0,this.m_distance=t.SwitchInfo.SCD}IsChange(){const t={};window.STATUSMONITOR.getCoordinateInfo(t);const e=t.distance-this.m_startDistance;let i=!1;return this.m_distance>0?e>this.m_distance&&(i=!0):this.m_distance<0?e<this.m_distance&&(i=!0):(this.preDistance>0&&e<=0||this.preDistance<0&&e>=0)&&(i=!0),this.preDistance=e,i}setCalibrationInfo(t){super.SetCaribrationInfo(t)}GetStatus(){return super.GetStatus()}}const m=class m extends L{constructor(){super(),this.taskPriority=3,this.mIsWaitChange=!1,this.m_CommandSet={},this.m_calibInfo={},this.m_switchMethodTbl=[{bit:m.SW_TIMER,switchMethod:new ut},{bit:m.SW_VAR,switchMethod:new mt},{bit:m.SW_COLOR,switchMethod:new ft},{bit:m.SW_DIR,switchMethod:new gt},{bit:m.SW_DISTANCE,switchMethod:new wt}]}static getInstance(){return m.mSingleton||(m.mSingleton=new m),m.mSingleton}setCalibrationInfo(t){this.m_calibInfo=t}start(){}run(){const t=this.peekMessage();t&&t.getId()===n.CMD_CHANGE_SCENARIO&&(this.m_CommandSet=t.getData(),this.changeSwitchMethod(),this.mIsWaitChange=!1),window.SOROT.getStatus()===I.Running&&this.navigatorRun()}changeSwitchMethod(){if(this.m_CommandSet.SNO!=="END_SCENARIO")for(const t of this.m_switchMethodTbl)this.m_CommandSet.SwitchInfo.SCJFN&t.bit&&(t.switchMethod.Init(this.m_CommandSet),t.switchMethod.SetCaribrationInfo(this.m_calibInfo))}navigatorRun(){var r;let t=1,e=0,i=0,s=g.JS_CONTINUE;for(const c of this.m_switchMethodTbl)if(this.m_CommandSet.SwitchInfo.SCJFN&c.bit){if(s=c.switchMethod.GetStatus(),c.bit===g.SW_VAR){s===g.JS_NEXT&&(t=2,e=this.m_CommandSet.SwitchInfo.JMPSNO,i=1),s=g.JS_NEXT;break}if(s!==g.JS_CONTINUE)break}if(this.m_CommandSet.RunInfo.SONAR){let c;window.STATUSMONITOR.getBodyInfo(c),(r=c.SonarTarget)!=null&&r.isFound&&(I.setIsSonarTarget(!0),s=g.JS_NEXT)}switch(s){case g.JS_CONTINUE:break;case g.JS_NEXT:if(!this.mIsWaitChange){const c=[t,e,i],h=new n(n.CMD_CHANGE_SCENARIO,c);console.log("SCENARIOCONTROL->sendMessage"),window.SCENARIOCONTROL.sendMessage(h),this.mIsWaitChange=!0}break}}stop(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};a(m,"SW_TIMER",1),a(m,"SW_VAR",2),a(m,"SW_X",4),a(m,"SW_Y",8),a(m,"SW_COLOR",16),a(m,"SW_DIR",32),a(m,"SW_STAIR",64),a(m,"SW_DISTANCE",128),a(m,"SW_STOP",256),a(m,"SW_SYNC",512),a(m,"mSingleton",null);let y=m;window.NAVIGATOR=y.getInstance();class Y{constructor(t=0,e=0){this.forward=t,this.turn=e}}class F{constructor(){}reset(){}getRunParameter(t,e){return isNaN(e.FWD)&&(e.FWD=0),isNaN(e.TRN)&&(e.TRN=0),new Y(e.FWD,e.TRN)}}typeof window>"u"&&(global.window=global);class H extends F{constructor(t){super(),this.mEdge=t,this.m_IntegVal=0}reset(){}getRunParameter(t,e){const i={forward:e.FWD,turn:0};let s={};if(window.STATUSMONITOR.getColorInfo(s),s.ColorSensorValue>750)return{forward:0,turn:0};const r=this.getProportional(e.KP,t,s,e),c=this.getIntegral(e.KI,r,s,e),h=this.getDifferential(e.KD,t,s,e);let d=r+c+h;return d=Math.max(-100,Math.min(100,d)),i.turn=i.forward===0?0:d,i}getProportional(t,e,i,s){const r=t,c=this.getLineColor(e),h=this.getOutColor(e),d=this.getThresholdOfTargetColor(c,h,s.WPER),w=c-h||1,p=i.ColorSensorValue,et=this.mEdge==="LEFT"?d-p:p-d;let it=r*et*10/w;return Math.max(-100,Math.min(100,it))}getThresholdOfTargetColor(t,e,i){return(t+e)/2-(t-e)*i/100}getIntegral(t,e,i,s){const r=t;if(s.NOBLNCE){let c=r*e/1e3+this.m_IntegVal;const h=e+this.m_IntegVal;return h>100?c=Math.max(0,100-e):h<-100&&(c=Math.min(0,-100-e)),this.m_IntegVal=Math.max(-100,Math.min(100,c)),this.m_IntegVal}else{let c=(i.diffSumChangeRateAryLast-i.diffSumChangeRateAry)/2*.004;return this.mEdge!=="LEFT"&&(c=-c),r*c/10}}getDifferential(t,e,i,s){const r=t,c=this.getLineColor(e)-this.getOutColor(e)||1;let h=i.diffSumChangeRateAry;return this.mEdge!=="LEFT"&&(h=-h),r*h*10/c}getLineColor(t){return t.mCalBlack}getOutColor(t){return t.mCalWhite}}typeof window>"u"&&(global.window=global);class St extends F{constructor(){super(),this.mHasPreDiff=!1,this.mBodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0}}getRunParameter(t,e){let i={};const s={forward:e.FWD,turn:0};window.STATUSMONITOR.getBodyInfo(i);const r=[0,0];let c=e.TRN;this.mHasPreDiff||(this.mBodyInfo.EncoderValue.LEFT=i.EncoderValue.LEFT,this.mBodyInfo.EncoderValue.RIGHT=i.EncoderValue.RIGHT,this.mHasPreDiff=!0),r.LEFT=i.EncoderValue.LEFT-this.mBodyInfo.EncoderValue.LEFT,r.RIGHT=i.EncoderValue.RIGHT-this.mBodyInfo.EncoderValue.RIGHT,c!==0&&(c>0?r.RIGHT=Math.floor(r.RIGHT*(1+c/100)):r.LEFT=Math.floor(r.LEFT*(1+-c/100)));const h=r.RIGHT-r.LEFT;return c+=h,s.turn=Math.max(-100,Math.min(100,c)),s}}typeof window>"u"&&(global.window=global);class Ct extends F{constructor(){super(),this.mTurn=0,this.mCount=0}getRunParameter(t,e){return e.TRN>0?this.mTurn<e.TRN&&(this.mTurn+=this.mCount++%3===0?1:0):this.mTurn>e.TRN&&(this.mTurn-=this.mCount++%3===0?1:0),new Y(e.FWD,this.mTurn)}reset(){this.mTurn=0,this.mCount=0}}const It=1,Rt=2,Tt=3,Mt=5,P=[{type:It,runMethod:new H("LEFT")},{type:Rt,runMethod:new H("RIGHT")},{type:Tt,runMethod:new Ct},{type:Mt,runMethod:new St}];class Ot{static factory(t){for(let e=0;e<P.length;e++)if(t===P[e].type)return P[e].runMethod;return null}}const Nt=1,M=class M extends L{static getInstance(){return M.instance||(M.instance=new M(window.LEFTMOTOR,window.RIGHTMOTOR,window.ARMMOTOR)),M.instance}constructor(t,e,i){super(),this.motorL=t,this.motorR=e,this.armMotor=i,this.runMethod=null,this.msecCount=0,this.maxCount=0,this.gyroOffsetAdj2=0,this.blnceGyro=0,this.preNoneBalancer=0,this.commandSet={RunInfo:{}},this.calibrationInfo={},this.armCount=0,this.preFwd=0,this.preTurn=0,this.pwmL=0,this.pwmR=0,this.armOnly=!1}start(){console.log("RunCtrl start")}run(){const t=this.peekMessage();if(t)switch(t.getId()){case n.CMD_CHANGE_SCENARIO:this.commandSet=t.getData(),this.changeRunMethod();break}this.msecCount=this.msecCount===0?1:0,this.armOnly||this.controlRun(),this.controlArm()}changeRunMethod(){window.formData.setValue("sno",this.commandSet.SNO),window.formData.setValue("cno",this.commandSet.CNO),window.formData.setValue("fwd",this.commandSet.RunInfo.FWD),window.formData.setValue("trn",this.commandSet.RunInfo.TRN),console.log(`changeRun: FUNCNO=${this.commandSet.RunInfo.FUNCNO} FWD=${this.commandSet.RunInfo.FWD}`),this.runMethod=Ot.factory(this.commandSet.RunInfo.FUNCNO),this.runMethod&&this.runMethod.reset(),this.armMotor.reset(),this.armCount=this.armMotor.getCount()}controlRun(){if(!this.runMethod){console.log("RunMethod ERROR");return}const t=this.runMethod.getRunParameter(this.calibrationInfo,this.commandSet.RunInfo);if(this.commandSet.RunInfo.NOBLNCE===0){if(this.preNoneBalancer===1&&window.STATUSMONITOR.resetMotor(),this.msecCount===0){const e={};window.STATUSMONITOR.getBodyInfo(e),this.blnceGyro=this.calibrationInfo.gyroOffset+this.commandSet.RunInfo.GYOFST+this.gyroOffsetAdj2,this.preFwd=t.forward,this.preTurn=t.turn}else if(this.preFwd===t.forward&&this.preTurn!==0){if(t.forward===0)this.pwmL=this.pwmL*t.turn/this.preTurn,this.pwmR=this.pwmR*t.turn/this.preTurn;else{const e=Math.abs(this.pwmL-this.pwmR)/2,i=e*t.turn/this.preTurn-e;this.pwmL+=i,this.pwmR-=i}this.pwmL=Math.max(-100,Math.min(100,this.pwmL)),this.pwmR=Math.max(-100,Math.min(100,this.pwmR))}}else if(this.commandSet.RunInfo.NOBLNCE===1){let e=t.forward+t.turn/2,i=t.forward-t.turn/2;e>100?(this.pwmL=100,this.pwmR=i-(e-100)):i>100?(this.pwmR=100,this.pwmL=e-(i-100)):(this.pwmL=e,this.pwmR=i),t.forward===0&&(this.pwmL=this.commandSet.RunInfo.TRN/2,this.pwmR=-this.commandSet.RunInfo.TRN/2),this.preFwd=t.forward,this.preTurn=t.turn}this.preNoneBalancer=this.commandSet.RunInfo.NOBLNCE,this.motorL.setPWM(this.pwmL),this.motorR.setPWM(this.pwmR),this.commandSet.RunInfo.SPFLG&Nt?(this.gyroOffsetAdj2=-(this.pwmL+this.pwmR)*.2,this.gyroOffsetAdj2=Math.max(-20,Math.min(0,this.gyroOffsetAdj2))):this.gyroOffsetAdj2=0}controlArm(){if(!this.commandSet.RunInfo||!this.commandSet.RunInfo.ARMANG)return;const t=this.commandSet.RunInfo.ARMANG;if(t!==0){const e=this.armMotor.getCount()-this.armCount;let i=0;t>0?i=e<t?100:0:i=e>t?-100:0,this.armMotor.setPWM(i)}}stop(){}getRunConInfo(){return{SNO:this.commandSet.SNO,CNO:this.commandSet.CNO,fwd:this.preFwd,turn:this.preTurn,pwmL:this.pwmL,pwmR:this.pwmR,gyro:this.blnceGyro}}setCalibrationInfo(t){this.calibrationInfo={...t}}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};a(M,"instance",null);let x=M;class K{constructor(){this.yamlParser=null,this.loadYAMLParser()}async loadYAMLParser(){try{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js",t.onload=()=>{this.yamlParser=window.jsyaml,console.log("YAMLパーサーが読み込まれました")},document.head.appendChild(t)}catch(t){console.error("YAMLパーサーの読み込みに失敗しました:",t)}}parseYAML(t){if(!this.yamlParser)throw new Error("YAMLパーサーが読み込まれていません");try{return this.yamlParser.load(t)}catch(e){throw console.error("YAMLパースエラー:",e),new Error(`YAML設定ファイルのパースに失敗しました: ${e.message}`)}}async loadYAMLConfig(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const i=await e.text();return this.parseYAML(i)}catch(e){throw console.error(`YAML設定ファイル読み込みエラー (${t}):`,e),e}}async loadYAMLConfigs(t){const e={};for(const i of t)try{const s=i.split("/").pop().replace(".yaml","").replace(".yml","");e[s]=await this.loadYAMLConfig(i)}catch(s){console.warn(`YAML設定ファイル ${i} の読み込みをスキップしました:`,s)}return e}}class J{constructor(){this.loader=new K,this.currentYear="2023",this.configs=new Map,this.isLoaded=!1}async initialize(){try{await this.waitForYAMLParser(),await this.loadAllConfigs(),this.isLoaded=!0,console.log("YAML設定の読み込みが完了しました")}catch(t){throw console.error("YAML設定の読み込みに失敗しました:",t),t}}async waitForYAMLParser(){return new Promise(t=>{const e=()=>{this.loader.yamlParser?t():setTimeout(e,100)};e()})}async loadAllConfigs(){const t=["2023","2024","2025","Test"];for(const e of t)try{const i=await this.loadYearConfig(e);this.configs.set(e,i),console.log(`${e}年のYAML設定を読み込みました`)}catch(i){console.warn(`${e}年のYAML設定読み込みをスキップしました:`,i)}}async loadYearConfig(t){const e=[`config/years/${t}/robot.yaml`,`config/years/${t}/course.yaml`],i=await this.loader.loadYAMLConfigs(e);return{year:t,robot:i.robot||{},course:i.course||{},sensors:i.sensors||{},rules:i.rules||{}}}getCurrentConfig(){return this.getConfig(this.currentYear)}getConfig(t){if(!this.isLoaded)throw new Error("設定がまだ読み込まれていません。initialize()を先に呼び出してください。");const e=this.configs.get(t);if(e.imgpath=this.getPath(t)+e.course.image.filename,!e)throw new Error(`${t}年の設定が見つかりません`);return e}setCurrentYear(t){if(!this.configs.has(t))throw new Error(`${t}年の設定が読み込まれていません`);this.currentYear=t,console.log(`現在の年度を${t}年に設定しました`)}getAvailableYears(){return Array.from(this.configs.keys()).sort()}getPath(t){return`/sorot_spike_web_public/config/years/${t}/`}}window.YAMLConfigManager=J;window.YAMLConfigLoader=K;class At{constructor(t,e){this.name=t;const i=.5;this.scale=i,this.x=e.robot.initial_position.x,this.y=e.robot.initial_position.y,this.angle=e.robot.initial_position.angle*(Math.PI/180),this.width=e.robot.width*i,this.height=e.robot.height*i,this.wheelBase=e.robot.wheel.interval*i,this.wheelRadius=e.robot.wheel.radius*i,this.wheelWidth=5*i,this.leftPower=0,this.rightPower=0,this.maxSpeed=e.robot.speed.max_speed,this.color=e.robot.color,this.sensorColor=e.robot.sensorColor,this.wheelColor=e.robot.wheelColor,this.axleColor=e.robot.axleColor,this.sensor={r:0,g:0,b:0,brightness:0},this.status="idle",console.log(`${this.name} ロボットが起動しました。初期位置: (${this.x}, ${this.y})`)}move(t,e,i,s){const r=parseFloat(t),c=parseFloat(e);this.angle=i+s*(Math.PI/180);const h=(r+c)/2*this.maxSpeed/1e3;isNaN(h)||(this.x+=h*Math.cos(this.angle),this.y+=h*Math.sin(this.angle))}stop(){if(this.status==="idle"){console.log(`${this.name} は既に停止しています。`);return}console.log(`${this.name} が動作を停止しました。`),this.status="idle"}moveByVelocity(t,e,i){typeof t!="number"&&(t=0),typeof e!="number"&&(e=0),(typeof i!="number"||i<=0)&&(i=.1),this.angle+=e*i,this.x+=t*Math.cos(this.angle)*i,this.y+=t*Math.sin(this.angle)*i}getPose(){return{x:this.x,y:this.y,angle:this.angle}}getStatus(){return`${this.name} の現在の状態: ${this.status}, 位置: (${this.x}, ${this.y})`}}class pt{constructor(t){this.robot=t,this.isDragging=!1,this.pre=document.getElementById("outputContent"),this.canvas=document.getElementById("field"),this.pdfcanvas=document.getElementById("pdf"),this.trailcanvas=document.getElementById("trailCanvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.pdfctx=this.pdfcanvas.getContext("2d",{willReadFrequently:!0}),this.trailctx=this.trailcanvas.getContext("2d",{willReadFrequently:!0}),this.trail=[],this._setupEventListeners()}_setupEventListeners(){this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this._handleMouseUp.bind(this))}_handleMouseDown(t){const e=t.clientX-this.canvas.offsetLeft,i=t.clientY-this.canvas.offsetTop;if(Array.isArray(window.SCENARIO_MARKERS))for(let s=0;s<window.SCENARIO_MARKERS.length;s++){const r=window.SCENARIO_MARKERS[s],c=e-r.robot.x,h=i-r.robot.y,d=c*c+h*h,w=Math.max(this.robot.width,this.robot.height);if(d<=w*w){this._showMarkerInfo(r);return}}e>=this.robot.x-this.robot.width/2&&e<=this.robot.x+this.robot.width/2&&i>=this.robot.y-this.robot.height/2&&i<=this.robot.y+this.robot.height/2&&(this.isDragging=!0)}_showMarkerInfo(t){if(this.pre){const e=new Date(t.timestamp).toLocaleString(),i=t.timestamp%1e3;this.pre.innerHTML+=`Marker @ ${e} ${i}ms: `,this.pre.innerHTML+=`x=${t.robot.x}, y=${t.robot.y}, angle=${t.robot.angle}
`}else console.log("Marker",t)}_handleMouseMove(t){const e=t.clientX-this.canvas.offsetLeft,i=t.clientY-this.canvas.offsetTop;let s=!1;if(Array.isArray(window.SCENARIO_MARKERS))for(let r=0;r<window.SCENARIO_MARKERS.length;r++){const c=window.SCENARIO_MARKERS[r],h=e-c.robot.x,d=i-c.robot.y,w=h*h+d*d,p=Math.max(this.robot.width,this.robot.height);if(w<=p*p){s=!0;break}}this.canvas.style.cursor=s?"pointer":this.isDragging?"grabbing":"default",this.isDragging&&(this.robot.x=e,this.robot.y=i,this.draw())}_handleMouseUp(){this.isDragging=!1}inits(){this.drawBackground()}async loop(){this.updateRobot(),this.draw(),this.drawTrail();const t=this.getSensorColor(this.robot.x,this.robot.y,this.robot.angle),e=this.getSensorColor(this.robot.x+1,this.robot.y,this.robot.angle),i=Math.round((t.r+t.g+t.b)/3*70/255),s=Math.round((e.r+e.g+e.b)/3*70/255),r=(i+s)/2;this.robot.sensor={r:t.r,g:t.g,b:t.b,brightness:r};const c=`rgb(${Math.floor(t.r).toString().padStart(3,"0")},${Math.floor(t.g).toString().padStart(3,"0")},${Math.floor(t.b).toString().padStart(3,"0")})`;this.ctx.fillStyle=c,this.ctx.fillRect(10,30,20,20),this.ctx.fillStyle="black",this.ctx.font="16px sans-serif",this.ctx.fillText(`センサー色: ${c} (明度: ${r})`,10,20),this.trail.push({x:window.formData.getValue("xCoord"),y:window.formData.getValue("yCoord")}),requestAnimationFrame(this.loop.bind(this))}updateRobot(){if(window.LEFTMOTOR&&window.RIGHTMOTOR&&window.formData){const t=window.formData.getValue("leftPower"),e=window.formData.getValue("rightPower");let i={};window.STATUSMONITOR.getCoordinateInfo(i),console.log(`coordinate.driveDirection: ${i.driveDirection}`),this.robot.move(t,e,i.driveDirection,window.config.robot.initial_position.angle)}window.formData.renderRobot(this.robot)}drawBackground(){const i="/sorot_spike_web_public/"+window.configManager.getCurrentConfig().imgpath.replace(/^\//,"");pdfjsLib.getDocument(i).promise.then(r=>{console.log("PDF読み込み完了, ページ数:",r.numPages),r.getPage(1).then(c=>{const d=c.getViewport({scale:1});this.pdfcanvas.height=d.height,this.pdfcanvas.width=d.width/2;const w={canvasContext:this.pdfctx,viewport:d.clone({offsetX:0,offsetY:0})};c.render(w)})})}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.robot.x,this.robot.y),this.ctx.rotate(this.robot.angle),this.drawRobot(this.ctx,this.robot)}drawTrail(){if(!(this.trail.length<2)&&(this.trailctx.strokeStyle="rgb(255, 0, 0)",this.trailctx.lineWidth=2,this.trailctx.beginPath(),this.trail.length>1&&(this.trailctx.moveTo(this.trail[this.trail.length-2].x,this.trail[this.trail.length-2].y),this.trailctx.lineTo(this.trail[this.trail.length-1].x,this.trail[this.trail.length-1].y)),this.trailctx.stroke(),this.trailctx.closePath(),Array.isArray(window.SCENARIO_MARKERS)&&window.SCENARIO_MARKERS.length>0)){const t=window.SCENARIO_MARKERS[window.SCENARIO_MARKERS.length-1];t.isDraw||(t.isDraw=!0,this.trailctx.save(),this.trailctx.translate(t.robot.x,t.robot.y),this.trailctx.rotate(t.robot.angle),this.drawRobot(this.trailctx,t.robot),this.trailctx.fillStyle="black",this.trailctx.font="12px sans-serif",this.trailctx.fillText(`S:${t.commandSet.SNO} C:${t.commandSet.CNO}`,t.robot.x+20,t.robot.y-10))}}drawRobot(t,e){t.fillStyle=e.wheelColor,t.fillRect(-1*e.height,-1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillRect(-1*e.height,1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillStyle=e.axleColor,t.fillRect(-1*e.height/2,-1*e.width,5,e.wheelBase*2/3),t.fillStyle=e.color,t.beginPath(),t.fillRect(-e.height/2,-e.width/2,e.height,e.width),t.closePath(),t.fillStyle=e.sensorColor,t.beginPath(),t.arc(e.height/2,0,3,0,Math.PI*2),t.fill(),t.closePath(),t.restore()}getSensorColor(t,e,i){let s=t+Math.cos(i)*(this.robot.width/2),r=e+Math.sin(i)*(this.robot.width/2)+5;s=Math.floor(this.pdfcanvas.width/this.canvas.width*s),r=Math.floor(this.pdfcanvas.height/this.canvas.height*r);const c=this.pdfctx.getImageData(s,r,1,1).data;return{r:c[0],g:c[1],b:c[2]}}}class j{constructor(){}initializeScenarioData(t){return Array.isArray(t)?t.map(e=>{const i={...e};return i.RunInfo||(i.RunInfo={}),isNaN(i.RunInfo.FUNCNO)&&(i.RunInfo.FUNCNO=0),isNaN(i.RunInfo.FWD)&&(i.RunInfo.FWD=0),isNaN(i.RunInfo.TRN)&&(i.RunInfo.TRN=0),isNaN(i.RunInfo.KP)&&(i.RunInfo.KP=0),isNaN(i.RunInfo.KI)&&(i.RunInfo.KI=0),isNaN(i.RunInfo.KD)&&(i.RunInfo.KD=0),isNaN(i.RunInfo.NOBLNCE)&&(i.RunInfo.NOBLNCE=0),isNaN(i.RunInfo.WPER)&&(i.RunInfo.WPER=0),i.SwitchInfo||(i.SwitchInfo={}),isNaN(i.SwitchInfo.SCJFN)&&(i.SwitchInfo.SCJFN=0),isNaN(i.SwitchInfo.SCT)&&(i.SwitchInfo.SCT=0),isNaN(i.SwitchInfo.SCD)&&(i.SwitchInfo.SCD=0),isNaN(i.SwitchInfo.SCR)&&(i.SwitchInfo.SCR=0),isNaN(i.SwitchInfo.SCC)&&(i.SwitchInfo.SCC=0),isNaN(i.SwitchInfo.SCV)&&(i.SwitchInfo.SCV=0),isNaN(i.SwitchInfo.JMPSNO)&&(i.SwitchInfo.JMPSNO=0),isNaN(i.SwitchInfo.SCX)&&(i.SwitchInfo.SCX=0),isNaN(i.SwitchInfo.SCY)&&(i.SwitchInfo.SCY=0),i.CoordCorrectInfo||(i.CoordCorrectInfo={}),i}):(console.warn("シナリオデータが配列ではありません。初期化をスキップします。",t),t)}async loadScenarioFromUrl(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTPエラー! ステータス: ${e.status} (${t})`);const i=await e.text();return this.loadScenarioFromText(i)}catch(e){throw console.error(`シナリオデータ (${t}) の読み込みまたはパース中にエラーが発生しました:`,e),e}}loadScenarioFromText(t){try{let e=JSON.parse(t);return e=this.initializeScenarioData(e),console.log("シナリオデータ（初期化後）:",e),e}catch(e){throw console.error("JSONテキストのパース中にエラーが発生しました:",e),e}}}class Dt{constructor(t){this.formId=t}setValue(t,e){const i=document.getElementById(t);i?isNaN(e)?i.value=e:i.value=Math.round(e):console.warn(`Field with ID ${t} not found.`)}getValue(t){const e=document.getElementById(t);return e?e.value:null}renderCoordinate(t){try{this.setValue("distance",t.distance),this.setValue("x",t.x),this.setValue("y",t.y),this.setValue("angle2",t.driveDirection*180/Math.PI)}catch(e){console.error("renderCoordinate failed",e)}}renderRobot(t){this.setValue("xCoord",t.x),this.setValue("yCoord",t.y),this.setValue("angle",t.angle*180/Math.PI)}}let O=null,k;document.addEventListener("DOMContentLoaded",function(){O=document.getElementById("outputContent"),k=document.getElementById("field"),k.getContext("2d",{willReadFrequently:!0})});const N=5;let A=null;async function X(){console.log(`navigator
`);const o=y.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function Q(){console.log(`status_monitor_task
`);const o=b.getInstance();for(;;){o.run(),await new Promise(e=>setTimeout(e,10));const t={};window.STATUSMONITOR.getCoordinateInfo(t),window.formData.renderCoordinate(t)}}async function G(){console.log(`scenario_control_task
`);const o=E.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function z(){console.log("sorot"),window.SOROT.run()}async function q(){console.log(`run_control_task
`);const o=x.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function Z(){await new Promise(t=>setTimeout(t,1e3));let o={};for(window.SOROT.initialize(),Et(o),await new Promise(t=>setTimeout(t,1e3)),O.innerHTML+=`シナリオ読み込み開始
`,bt(o),G(),await new Promise(t=>setTimeout(t,1e3));;){if(SCENARIOCONTROL.mSubScenarioList.length>0){for(let t of SCENARIOCONTROL.mSubScenarioList[0].mArrCommandSet)O.innerHTML+=`ScenaIN ${t.SNO} ${t.CNO}
`;break}await new Promise(t=>setTimeout(t,1e3))}O.innerHTML+=`シナリオが読み込み完了
`,yt(o),await new Promise(t=>setTimeout(t,1e3)),await new Promise(t=>setTimeout(t,1e3))}async function Et(o,t){let e=0,i;return o.cmdID=n.CMD_INIT,e=N,window.SOROT.setStatus(I.Idle),i=new n(o.cmdID,o.data,0),window.SOROT.sendMessage(i),e}async function bt(o,t){let e=0,i,s=0;console.log(`dummy loadScenario
`),console.log(`loadScenario Sorot::Idle
`),console.log("読み込み");for(let c=0;c<A.length;c++)o.cmdID=n.CMD_INSERT_SCENARIO,o.data=A[c],i=new n(o.cmdID,o.data,N),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(i);o.cmdID=n.CMD_INSERT_SUB_LIST,e=N,i=new n(o.cmdID,o.data,0),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(i);const r=new Array(1);for(r[0]=24,s=0;s<r.length;s++)o.data[s]=r[s],console.log(`LOAD ${s}: ${r[s]}`);return console.log("読み込み完了"),o.cmdID=n.CMD_INSERT_SCN_LIST,e=N+s,i=new n(o.cmdID,o.data,e),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(i),window.SOROT.setStatus(I.Downloaded),e}async function yt(o){let t=0,e;return o.cmdID=n.CMD_START_CALIB,t=N,window.SOROT.setStatus(I.Calibrating),e=new n(o.cmdID,o.data,0),console.log("SOROT->sendMessage"),window.SOROT.doCalibration(e),t}async function tt(){await new Promise(t=>setTimeout(t,1e3)),Lt({}),await new Promise(t=>setTimeout(t,1e3))}async function Lt(o,t){let e=0,i;return console.log("dummy readyToStart 217"),o.cmdID=n.CMD_START,o.data={0:0,1:0},e=N+2,window.SOROT.setStatus(I.Running),i=new n(o.cmdID,o.data,2),console.log("SOROT->sendMessage"),window.SOROT.sendMessage(i),e}async function $(){const o=window.formData.getValue("scenarioInput");try{A=await new j().loadScenarioFromText(o),console.log("シナリオデータ（初期化後）:",A)}catch(t){console.error(`JSONの解析中にエラーが発生しました: ${t.message} (位置: ${t.position})`),O.innerHTML+=`無効なJSON形式です。
`;return}await Promise.all([G(),Z()])}async function B(){window.robot.x=u.robot.init.x,window.robot.y=u.robot.init.y,window.robot.angle=u.robot.init.angle,Promise.all([z()]),await Promise.all([X(),q(),Q(),tt()])}async function W(){let o;try{const i=await fetch(u.config.robot.scenario.unittest_url);if(!i.ok)throw new Error(`HTTPエラー! ステータス: ${i.status} (${url})`);o=await i.text()}catch(i){throw console.error(`シナリオデータ (${url}) の読み込みまたはパース中にエラーが発生しました:`,i),i}let t=JSON.parse(o);const e=new j;if(Array.isArray(t)){console.log(`単体テスト用に複数のシナリオ (${t.length}個) が読み込まれました。各シナリオを順次確認します。`);for(const[i,s]of t.entries()){A=e.initializeScenarioData(t[i]),window.formData.setValue("scenarioInput",JSON.stringify(A,null,4)),Promise.all([G(),Z()]),await new Promise(d=>setTimeout(d,3e3)),window.robot.x=u.robot.init.x,window.robot.y=u.robot.init.y,window.robot.angle=u.robot.init.angle;const r=new f("leftPower"),c=new f("rightPower");window.LEFTMOTOR=r,window.RIGHTMOTOR=c;const h=new U(r,c);window.HWMONITOR=h,Promise.all([z(),X(),q(),Q(),tt()]),await new Promise(d=>setTimeout(d,1e4)),window.SCENARIOCONTROL.clearScenario(),window.SCENARIOCONTROL.mScnNoListIndex=0,window.SCENARIOCONTROL.mSubScenarioList=[]}}}document.addEventListener("DOMContentLoaded",async()=>{const o=new J;await o.initialize(),window.configManager=o;const t=o.getCurrentConfig(),e=new At("robot",t);e.init={...e};const i=new pt(e);i.inits(),i.loop(),u.robot=e,u.config=t,u.SOROT=new I(1),u.RUNCONTROL=x.getInstance(),u.STATUSMONITOR=b.getInstance(),u.SCENARIOCONTROL=E.getInstance(),u.NAVIGATOR=y.getInstance(),u.SCENARIO_MARKERS=[],u.RCVHEADERSIZE=N,u.gWhite=t.robot.sensors.color.white_threshold,u.gBlack=t.robot.sensors.color.black_threshold;const s=t.robot.scenario.url,r=await fetch(s).then(c=>c.text());u.formData.setValue("scenarioInput",r)});const u=typeof window<"u"?window:globalThis;u.load=typeof $<"u"?$:void 0;u.main=typeof B<"u"?B:void 0;u.runUnitTest=typeof W<"u"?W:void 0;u.formData=new Dt("");document.addEventListener("DOMContentLoaded",function(){O=document.getElementById("outputContent"),document.getElementById("loadScenarioButton").addEventListener("click",function(){typeof window.load=="function"&&window.load()}),document.getElementById("startRunButton").addEventListener("click",function(){O.innerHTML+=`走行を開始します。
`,typeof window.main=="function"&&window.main()}),document.getElementById("startUnitTestButton").addEventListener("click",function(){typeof window.main=="function"&&window.runUnitTest()})});
//# sourceMappingURL=app-CNlhE8bX.js.map
