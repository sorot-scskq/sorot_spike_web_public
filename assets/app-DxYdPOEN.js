var rt=Object.defineProperty;var at=(n,t,e)=>t in n?rt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>at(n,typeof t!="symbol"?t+"":t,e);const ct=n=>n.toISOString().slice(0,19).replace("T"," "),F=(...n)=>{},ht=(...n)=>{{const t=new Date,e=ct(t),i=String(t.getMilliseconds()).padStart(3,"0");console.log(`[${e}.${i}]`,...n)}};class lt{constructor(t){this.mHead=null,this.mTail=null,this.mQueCnt=0,this.mTask=t}send(t){t.setNext(null),this.mTail&&this.mTail.setNext(t),this.mTail=t,this.mHead===null&&(this.mHead=t),this.mQueCnt++}get(){let t=null;return this.mHead&&(t=this.mHead,this.mHead=this.mHead.getNext(),this.mQueCnt--,this.mQueCnt===0&&(this.mTail=null)),t}wait(){for(;;){if(this.isReceived())return this.get();new Promise(t=>setTimeout(t,100))}}isReceived(){return this.mHead!==null}}class _{constructor(t){this.mQueue=new lt(t)}getMessage(){let t=null;return this.mQueue&&(t=this.mQueue.get()),t}peekMessage(){let t=null;return this.mQueue&&(t=this.mQueue.get(),t&&F(`mQueue->get(): ${t.getId()}`)),t}sendMessage(t){this.mQueue&&(this.mQueue.send(t),t&&F(`mQueue->send: ${t.getId()}`))}}const R=class R{constructor(){this.mArrCommandSet=[],this.mIndex=0}clear(){this.mArrCommandSet=[]}insertCommandSet(t){for(let e=0;e<this.mArrCommandSet.length;e++){const i=this.mArrCommandSet[e];if(i.SNO===t.SNO&&i.CNO===t.CNO)return this.mArrCommandSet.splice(e,1,t),R.UPDATE;if(i.SNO===t.PRVSNO&&i.CNO===t.PRVCNO)return this.mArrCommandSet.splice(e+1,0,t),R.INSERT}return this.mArrCommandSet.push(t),R.ADD}getCommandSet(){return this.mIndex<this.mArrCommandSet.length?this.mArrCommandSet[this.mIndex]:null}searchCommandSet(t,e){for(let i=0;i<this.mArrCommandSet.length;i++){const o=this.mArrCommandSet[i];if(o.SNO===t&&o.CNO===e)return this.mIndex=i,!0}return!1}getRecordCount(){return this.mArrCommandSet.length}moveFirst(){this.mIndex=0}moveNext(){this.mIndex++}};c(R,"INSERT",0),c(R,"UPDATE",1),c(R,"ADD",2);let D=R;class a{constructor(t=0,e=null,i=0){this.mId=t,this.mDataLen=i,this.mData=e,this.mNext=null}getTime(){return this.mTime}getId(){return this.mId}getData(){return this.mData}getDataLength(){return this.mDataLen}getNext(){return this.mNext}setNext(t){this.mNext=t}}c(a,"CMD_INIT",17),c(a,"CMD_START",18),c(a,"CMD_GET_CALIBINFO",20),c(a,"CMD_SET_SOROTINFO",21),c(a,"CMD_START_CALIB",22),c(a,"CMD_SET_INDIVIDUAL",23),c(a,"CMD_GET_SOROTINFO",33),c(a,"CMD_CHANGE_SCENARIO",49),c(a,"CMD_INSERT_SCENARIO",50),c(a,"CMD_CLEAR_SCENARIO",51),c(a,"CMD_STOP",52),c(a,"CMD_SET_SCENARIOINFO",53),c(a,"CMD_SYNC",54),c(a,"CMD_INSERT_SUB_LIST",55),c(a,"CMD_INSERT_SCN_LIST",56),c(a,"CMD_COMPLETE_BT",144),c(a,"CMD_CORRECT_COORDINF",145),c(a,"CMD_SONARSENSOR",146),c(a,"ERR_OK",0),c(a,"ERR_EXECCMD",1),c(a,"ERR_SCNRONO",2),c(a,"ERR_CHGSCNRO",3),c(a,"ERR_STATUS",33),c(a,"ERR_COMMAND",65),c(a,"ERR_DATALEN",66),c(a,"ERR_PARAM",67),c(a,"ERR_SEQNO",68),c(a,"ERR_CHECKSUM",69),c(a,"ERR_HARDWARE",97),c(a,"ERR_LOGICAL",145),c(a,"ERR_FATAL",153);const S=class S extends _{constructor(){super(),this.mScenario=new D,this.mIsSync=!1,this.mSubScenarioList=[],this.mSubScnListIndex=0,this.mScenarioNoList=[],this.mScnNoListIndex=0}start(){console.log("ScenarioCtrl start")}run(){let t=this.peekMessage();if(t!==null){switch(F(`ScenarioCtrl run. :${t.getId()}`),t.getId()){case a.CMD_CLEAR_SCENARIO:console.log("CMD_CLEAR_SCENARIO"),this.clearScenario(t);break;case a.CMD_INSERT_SCENARIO:console.log("CMD_INSERT_SCENARIO"),this.insertScenario(t);break;case a.CMD_START_CALIB:console.log("CMD_START_CALIB"),this.preStartScenario();break;case a.CMD_START:console.log("CMD_START"),this.nextScenario(t,!0);break;case a.CMD_STOP:console.log("CMD_STOP"),this.stopScenario(t);break;case a.CMD_CHANGE_SCENARIO:console.log("CMD_CHANGE_SCENARIO"),this.nextScenario(t,!1);break;case a.CMD_SYNC:console.log("CMD_SYNC"),this.mIsSync=!0;break;case a.CMD_INSERT_SUB_LIST:console.log("CMD_INSERT_SUB_LIST"),this.insertSubScenarioList();break;case a.CMD_INSERT_SCN_LIST:console.log("CMD_INSERT_SCN_LIST"),this.insertScenarioNoList(t);break}t=null}}clearScenario(t){this.mScenario=new D}insertScenario(t){let e=t.getData();this.mScenario.insertCommandSet(e),console.log(`ScenaIN ${e.SNO} ${e.CNO}`)}insertSubScenarioList(){this.mSubScenarioList.push(this.mScenario),this.mScenario=new D}insertScenarioNoList(t){console.log("insertScenarioNoList 開始");let e=t.getData(),i=t.getDataLength()-RCVHEADERSIZE;for(let o=0;o<i;o++)this.mScenarioNoList.push(e[o]),console.log(`ScnNo:${o} ${e[o]}`);console.log("insertScenarioNoList 完了")}preStartScenario(){console.log("preStartScenario 開始");let t={},e;this.mScenario=this.mSubScenarioList[0],this.mScenario&&(t=this.mScenario.getCommandSet(),console.log(`${this.constructor.name} ${t.SNO} ${t.CNO}`),e=new a(a.CMD_CHANGE_SCENARIO,t),window.RUNCONTROL.sendMessage(e),e=new a(a.CMD_CHANGE_SCENARIO,t),window.NAVIGATOR.sendMessage(e),console.log("preStartScenario 完了"))}stopScenario(t){}nextScenario(t,e){let i={},o,s=t.getData();if(e){if(s[0]===0&&s[1]===0)this.mScenario.moveFirst();else if(!this.mScenario.searchCommandSet(s[0],s[1])){console.log(`ScenaNG ${s[0]} ${s[1]}`);return}}else if(s[0]===1)this.mScenario.moveNext();else if(!this.mScenario.searchCommandSet(s[1],s[2])){console.log(`ScenaNG ${s[0]} ${s[1]}`);return}if(ht("ScenarioControl::nextScenario 1"),this.IsEndScenario())if(this.mScnNoListIndex++,this.mScnNoListIndex<this.mScenarioNoList.length)this.mScenario=this.mSubScenarioList[this.mScenarioNoList[this.mScnNoListIndex]],this.mScenario.moveFirst(),console.log(`ScnNo:${this.mScenarioNoList[this.mScnNoListIndex]}`);else{COMMANDDISPATCHER.sendResponse(t,a.ERR_OK);return}i=this.mScenario.getCommandSet(),console.log(`SNO:${i.SNO} CNO:${i.CNO}`);try{const h={SNO:this.mScenario.getCommandSet().SNO,CNO:this.mScenario.getCommandSet().CNO,timestamp:Date.now(),robot:JSON.parse(JSON.stringify(window.robot)),isDraw:!1,commandSet:JSON.parse(JSON.stringify(i))};Array.isArray(window.SCENARIO_MARKERS)||(window.SCENARIO_MARKERS=[]),window.SCENARIO_MARKERS.push(h)}catch(h){console.warn("Failed to capture marker",h)}i.CoordCorrectInfo.ACAF>0&&(o=new a(a.CMD_CORRECT_COORDINF,i.CoordCorrectInfo),window.STATUSMONITOR.sendMessage(o));let r=S.OFF;i.RunInfo.SONAR&&(r=S.ON),o=new a(a.CMD_SONARSENSOR,r),window.STATUSMONITOR.sendMessage(o),o=new a(a.CMD_CHANGE_SCENARIO,i),window.RUNCONTROL.sendMessage(o),o=new a(a.CMD_CHANGE_SCENARIO,i),window.NAVIGATOR.sendMessage(o),e&&(window.RUNCONTROL.ArmOnly=!1)}IsEndScenario(){return this.mScenario.getCommandSet().SNO===0&&this.mScenario.getCommandSet().CNO===0}static getInstance(){return S.mSingleton==null&&(S.mSingleton=new S),S.mSingleton}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};c(S,"mSingleton",null),c(S,"OFF",!1),c(S,"ON",!0);let b=S;window.SCENARIOCONTROL=b.getInstance();const T=class T extends _{constructor(t,e){super(),this.colorMonitor=t,this.hwMonitor=e,this.msecCount=0}start(){console.log("TaskStsMon run"),this.hwMonitor.resetDevice()}run(){let t=this.peekMessage();if(t!==null){switch(t.getId()){case a.CMD_CORRECT_COORDINF:window.HWMONITOR.correctCoordinateInfo(t.getData());break;case a.CMD_SONARSENSOR:window.HWMONITOR.setSonarSwitch(t.getData());break}t=null}this.colorMonitor.read(),this.msecCount===0?(this.msecCount=1,this.hwMonitor.read()):this.msecCount=0}stop(){}static getInstance(){return T.mSingleton==null&&(T.mSingleton=new T(window.COLORMONITOR,window.HWMONITOR)),T.mSingleton}resetMotor(){this.hwMonitor.resetDevice(!0)}getColorInfo(t){Object.assign(t,this.colorMonitor.getColorInfo())}getBodyInfo(t){Object.assign(t,this.hwMonitor.getBodyInfo())}getCoordinateInfo(t){try{Object.assign(t,this.hwMonitor.getCoordinateInfo())}catch(e){console.error(e)}}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};c(T,"mSingleton",null);let L=T;class g{constructor(t){this.name=t,this.fg_motor=null,this.pwm=0,this.count=0}setUp(t,e){console.log(`motor setup: ${e}`),console.log(e==="left"?`motor_setup left: ${e}`:`motor_setup other: ${e}`)}getPWM(){return isNaN(this.pwm)?0:this.pwm}setPWM(t){this.pwm=t,this.updateLeftPowerDisplay()}getCount(){let h=0,u=0;const w=this.getPWM();return u+=.1*(1*w-.5*u-.01*.1*Math.sign(u)-.01*.1),h+=.1*u,this.count+=h*window.robot.maxSpeed,this.count}reset(){return 0}updateLeftPowerDisplay(){window.formData.setValue(this.name,this.getPWM())}}c(g,"LEFT",0),c(g,"RIGHT",1),c(g,"MOTOR_NUM",2);const dt=20,x={WHITE:0,GRAY:1,BLACK:2,NONE:5};class ut{constructor(t,e=dt){c(this,"blueCount",0);this.port=t,this.blueCount=0,this.changeCount=e,this.changeRateArray=Array(e).fill(0),this.changeRateIndex=0,this.sumChangeRateArray=0,this.diffSumChangeRateAry=0,this.colorInfo={color:x.NONE,ColorSensorValue:0,diffValue:0,diffSumChangeRateAry:0,diffSumChangeRateAryLast:0}}getBrightness(){return robot.sensor.brightness}read(){const t=this.getBrightness();this.colorInfo.color=t<10?x.BLACK:t>60?x.WHITE:x.GRAY,this.colorInfo.ColorSensorValue=t,this.colorInfo.diffValue=this.getChangeRateWidth(t),this.colorInfo.diffSumChangeRateAryLast=this.colorInfo.diffSumChangeRateAry,this.colorInfo.diffSumChangeRateAry=this.diffSumChangeRateAry}getChangeRateWidth(t){this.changeRateArray[this.changeRateIndex%this.changeCount]=t,this.changeRateIndex++;const e=Math.min(this.changeRateIndex,this.changeCount),i=this.changeRateArray.slice(0,e),o=Math.max(...i),s=Math.min(...i),r=i.reduce((h,u)=>h+u,0);return this.diffSumChangeRateAry=this.sumChangeRateArray-r,this.sumChangeRateArray=r,o-s}getColorInfo(){return this.colorInfo}}class G{constructor(){this.x=0,this.y=0,this.distance=0,this.driveDirection=0,this.driveDirectionAve=0,this.driveDirectionAveLast=0,this.isObstacle=!1}}class U{constructor(t,e){this.motorL=t,this.motorR=e,this.resetDevice(),this.lastDistance=0,this.lastDriveDirection=0,this.spdSmplCnt=0,this.isCorrect={LEFT:!1,RIGHT:!1},this.beforeEncoderValue={LEFT:0,RIGHT:0},this.storedEncoder={LEFT:0,RIGHT:0},this.driveDirectionIdx=0,this.coordinate=new G,this.bodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0},this.drive_direction_cnt=window.config.robot.direction.drive_direction_cnt,this.driveDirectionAry=Array(window.drive_direction_cnt).fill(0),this.distanceDriveDirectionAry=Array(window.drive_direction_cnt).fill(0),this.speedBuf=Array(window.config.robot.speed.sample_num).fill(0),this.setWheelTransParam(window.config.robot.wheel.radius)}setWheelTransParam(t){this.wheelTransParam=2*Math.PI*t*100/100/360}resetDevice(t=!1){t&&(this.storedEncoder.LEFT+=this.motorL.getCount(),this.storedEncoder.RIGHT+=this.motorR.getCount()),this.motorL.reset(),this.motorR.reset(),this.coordinate=new G,this.bodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0}}setGyroOffSet(t){this.gyroOffSet=t}read(){let t=this.motorL.getCount(),e=this.motorR.getCount();this.bodyInfo.EncoderValue.LEFT-t>1e4&&(this.bodyInfo.EncoderValue.LEFT=0),this.bodyInfo.EncoderValue.RIGHT-e>1e4&&(this.bodyInfo.EncoderValue.RIGHT=0),this.calcCoordinates(this.storedEncoder.LEFT+t,this.storedEncoder.RIGHT+e),this.bodyInfo.EncoderValue.LEFT=t,this.bodyInfo.EncoderValue.RIGHT=e,this.getSpeed(),this.getDriveDirectionAve()}calcCoordinates(t,e){let i=new Array(g.MOTOR_NUM),o,s,r,h,u,w=new Array(g.MOTOR_NUM);w[g.LEFT]=t,w[g.RIGHT]=e,i[g.LEFT]=this.getMoterMoveDistance(this.beforeEncoderValue.LEFT,t),i[g.RIGHT]=this.getMoterMoveDistance(this.beforeEncoderValue.RIGHT,e),this.beforeEncoderValue.LEFT=t,this.beforeEncoderValue.RIGHT=e,!(i[g.LEFT]===0&&i[g.RIGHT]===0)&&(o=(i[g.LEFT]+i[g.RIGHT])/2,this.coordinate.distance+=o*window.config.robot.scale,i[g.LEFT]!==i[g.RIGHT]?(r=(i[g.LEFT]-i[g.RIGHT])/window.config.robot.wheel.interval,s=this.coordinate.driveDirection+r,s>2*Math.PI?s-=2*Math.PI:s<-2*Math.PI&&(s+=2*Math.PI),this.coordinate.driveDirection=s,h=2*o/r*Math.sin(r/2),u=-r/2+this.coordinate.driveDirection,this.coordinate.x-=h*Math.cos(u),this.coordinate.y+=h*Math.sin(u)):(this.coordinate.x-=o*Math.cos(this.coordinate.driveDirection),this.coordinate.y+=o*Math.sin(this.coordinate.driveDirection)))}getSpeed(){let t=0;this.speedBuf[this.spdSmplCnt]=(this.coordinate.distance-this.lastDistance)*1e3/window.STATUSMONITOR.TASK_PERIOD,this.spdSmplCnt++,this.spdSmplCnt>window.config.robot.speed.sample_num-1&&(this.spdSmplCnt=0);for(let i=0;i<window.config.robot.speed.sample_num;i++)t+=this.speedBuf[i];this.bodyInfo.RunSpeed=t/window.config.robot.speed.sample_num;let e=(this.coordinate.driveDirection-this.lastDriveDirection)*100;e>500||e<-500?this.bodyInfo.TurnSpeed=(this.coordinate.driveDirection+(2*Math.PI-this.lastDriveDirection))*100:this.bodyInfo.TurnSpeed=(this.coordinate.driveDirection-this.lastDriveDirection)*100,this.lastDistance=this.coordinate.distance,this.lastDriveDirection=this.coordinate.driveDirection}getMoterMoveDistance(t,e){return(e-t)*this.wheelTransParam}getDriveDirectionAve(){this.coordinate.distance-this.distanceDriveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]>3&&(this.driveDirectionIdx%this.drive_direction_cnt===0&&(this.coordinate.driveDirectionAveLast=this.coordinate.driveDirectionAve),this.driveDirectionIdx++,this.distanceDriveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]=this.coordinate.distance,this.driveDirectionAry[this.driveDirectionIdx%this.drive_direction_cnt]=this.coordinate.driveDirection,this.coordinate.driveDirectionAve=this.dAverage(this.driveDirectionAry,this.drive_direction_cnt))}dAverage(t,e){let i=0;for(let o=0;o<e;o++)i+=t[o];return i/e}getBodyInfo(){return this.bodyInfo}getCoordinateInfo(){return this.coordinate}correctCoordinateInfo(t){(t.ACAF&1)===1&&(this.coordinate.x=t.CAPX),(t.ACAF&2)===2&&(this.coordinate.y=t.CAPY),(t.ACAF&4)===4&&(this.coordinate.driveDirection=t.CAPR*Math.PI/180)}setSonarSwitch(t){this.bodyInfo.sonarOn=t,this.bodyInfo.SonarValue=0,this.coordinate.IsObstacle=!1}}const mt="leftPower",gt="rightPower",l=class l extends _{constructor(t){super(),this.taskId=t,this.isSonarTarget=!1,l.mStatus=l.Initial,l.mArmMotor=new g("c"),l.mRightMotor=new g(gt),l.mLeftMotor=new g(mt),l.mHWMonitor=new U(l.mLeftMotor,l.mRightMotor),window.COLORMONITOR=l.getColorMonitor(),window.HWMONITOR=l.getHWMonitor(),window.STATUSMONITOR=L.getInstance(),window.ARMMOTOR=l.getArmMotor(),window.RIGHTMOTOR=l.getRightMotor(),window.LEFTMOTOR=l.getLeftMotor()}async run(){let t=!1;console.log("wait sorot getMessage");let e;for(;;){if(e=this.getMessage(),e==null){await new Promise(i=>setTimeout(i,4));continue}switch(console.log(`SorotRcv: ${e.getId()}`),e.getId()){case a.CMD_INIT:console.log("Message.CMD_INIT"),this.setStatus(l.Idle);break;case a.CMD_SET_SOROTINFO:console.log("Message.CMD_SET_SOROTINFO"),this.setRunControlParam(e);break;case a.CMD_SET_INDIVIDUAL:console.log("Message.CMD_SET_INDIVIDUAL"),this.setIndividualParam(e);break;case a.CMD_START_CALIB:console.log("Message.CMD_START_CALIB"),await this.doCalibration(e),this.getCalibrationInfo(e),this.setStatus(l.Ready);break;case a.CMD_GET_CALIBINFO:console.log("Message.CMD_GET_CALIBINFO"),this.getCalibrationInfo(e);break;case a.CMD_START:console.log("Message.CMD_START"),this.setStatus(l.Running),this.startRun(e),t=!0;break}if(e=null,t)break}}initialize(){l.mArmMotor.setPWM(30),setTimeout(()=>{l.mArmMotor.setPWM(0),l.mArmMotor.reset()},600)}async doCalibration(t){window.RUNCONTROL.ArmOnly=!0,window.RUNCONTROL.start(),console.log("START CALIB");const e=gBlack,i=gWhite;console.log(gBlack);const o=Math.floor((e+i)/2);this.mCalInfo={mCalBlack:e,mCalGray:o,mCalWhite:i,mGyroOffset:0},window.RUNCONTROL.setCalibrationInfo(this.mCalInfo),window.NAVIGATOR.setCalibrationInfo(this.mCalInfo);const s=new a(t.getId(),t.getData(),t.getDataLength());window.SCENARIOCONTROL.sendMessage(s)}getCalibrationInfo(t){}startRun(t){const e=new a(t.getId(),t.getData(),t.getDataLength());window.STATUSMONITOR.start(),window.NAVIGATOR.start(),window.SCENARIOCONTROL.sendMessage(e)}setRunControlParam(t){const e=t.getData();A_D=e.A_D,A_R=e.A_R,K_F=[e.K_F0,e.K_F1,e.K_F2,e.K_F3],K_I=e.K_I,K_PHIDOT=e.K_PHIDOT,K_THETADOT=e.K_THETADOT}setIndividualParam(t){}setStatus(t){l.mStatus=t}getStatus(){return l.mStatus}static getColorMonitor(){return l.mColorMonitor}static getArmMotor(){return l.mArmMotor}static getRightMotor(){return l.mRightMotor}static getLeftMotor(){return l.mLeftMotor}static getHWMonitor(){return l.mHWMonitor}static getCalibration(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};c(l,"Initial",0),c(l,"Idle",1),c(l,"Downloaded",2),c(l,"Calibrating",3),c(l,"Ready",4),c(l,"Running",5),c(l,"Goal",6),c(l,"Retire",7),c(l,"mLCD",{}),c(l,"mArmMotor"),c(l,"mRightMotor"),c(l,"mLeftMotor"),c(l,"mColorMonitor",new ut("C")),c(l,"mHWMonitor"),c(l,"mStatus");let I=l;const C=class C{constructor(){this.m_LostCnt=0,this.m_pCaribInfo}IsLost(){return!1}GetStatus(){let t=C.JS_CONTINUE;return this.IsLost()?t=C.JS_LOST:this.IsChange()&&(t=C.JS_NEXT),t}IsChange(){return!1}SetCaribrationInfo(t){this.m_pCaribInfo=t}};c(C,"JS_CONTINUE",0),c(C,"JS_LOST",1),c(C,"JS_NEXT",2),c(C,"JS_RETURN",3);let f=C;typeof window>"u"&&(global.window=global);class ft extends f{constructor(){super(),this.m_PassageTime=0,this.m_startTime=Date.now(),this.m_clock={now:()=>Date.now()-this.m_startTime,reset:()=>{this.m_startTime=Date.now()}}}IsChange(){return this.m_clock.now()>this.m_PassageTime}Init(t){this.m_PassageTime=t.SwitchInfo.SCT}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class wt extends f{constructor(){super(),this.m_VarType=0}IsChange(){let t=!1;switch(this.m_VarType){case 0:t=!0;break;case 1:t=window.SOROT.getIsSwitchFlg();break}return t}Init(t){this.m_VarType=t.SwitchInfo.SCV}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class St extends f{constructor(){super(),this.m_naname=!1,this.m_targetColor=null}IsChange(){return this.getColorInfo().color===this.m_targetColor}Init(t){this.m_naname=t.RunInfo.NOBLNCE===1,this.m_targetColor=t.SwitchInfo.SCC}getColorInfo(){const t={};return window.STATUSMONITOR.getColorInfo(t),t}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class Ct extends f{constructor(){super(),this.m_PreDiff=0,this.m_TargetDir=0}IsChange(){let t;const e={};window.STATUSMONITOR.getCoordinateInfo(e),t=this.m_TargetDir-e.driveDirection;const i=this.m_PreDiff*t<=0;return this.m_PreDiff=t,i}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_TargetDir=t.SwitchInfo.SCR*(Math.PI/180)+e.driveDirection,this.m_PreDiff=this.m_TargetDir-e.driveDirection}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class It extends f{constructor(){super(),this.m_startDistance=0,this.preDistance=0,this.m_distance=0}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_startDistance=e.distance,this.preDistance=0,this.m_distance=t.SwitchInfo.SCD}IsChange(){const t={};window.STATUSMONITOR.getCoordinateInfo(t);const e=t.distance-this.m_startDistance;let i=!1;return this.m_distance>0?e>this.m_distance&&(i=!0):this.m_distance<0?e<this.m_distance&&(i=!0):(this.preDistance>0&&e<=0||this.preDistance<0&&e>=0)&&(i=!0),this.preDistance=e,i}setCalibrationInfo(t){super.SetCaribrationInfo(t)}GetStatus(){return super.GetStatus()}}const m=class m extends _{constructor(){super(),this.taskPriority=3,this.mIsWaitChange=!1,this.m_CommandSet={},this.m_calibInfo={},this.m_switchMethodTbl=[{bit:m.SW_TIMER,switchMethod:new ft},{bit:m.SW_VAR,switchMethod:new wt},{bit:m.SW_COLOR,switchMethod:new St},{bit:m.SW_DIR,switchMethod:new Ct},{bit:m.SW_DISTANCE,switchMethod:new It}]}static getInstance(){return m.mSingleton||(m.mSingleton=new m),m.mSingleton}setCalibrationInfo(t){this.m_calibInfo=t}start(){}run(){const t=this.peekMessage();t&&t.getId()===a.CMD_CHANGE_SCENARIO&&(this.m_CommandSet=t.getData(),this.changeSwitchMethod(),this.mIsWaitChange=!1),window.SOROT.getStatus()===I.Running&&this.navigatorRun()}changeSwitchMethod(){if(this.m_CommandSet.SNO!=="END_SCENARIO")for(const t of this.m_switchMethodTbl)this.m_CommandSet.SwitchInfo.SCJFN&t.bit&&(t.switchMethod.Init(this.m_CommandSet),t.switchMethod.SetCaribrationInfo(this.m_calibInfo))}navigatorRun(){var s;let t=1,e=0,i=0,o=f.JS_CONTINUE;for(const r of this.m_switchMethodTbl)if(this.m_CommandSet.SwitchInfo.SCJFN&r.bit){if(o=r.switchMethod.GetStatus(),r.bit===f.SW_VAR){o===f.JS_NEXT&&(t=2,e=this.m_CommandSet.SwitchInfo.JMPSNO,i=1),o=f.JS_NEXT;break}if(o!==f.JS_CONTINUE)break}if(this.m_CommandSet.RunInfo.SONAR){let r;window.STATUSMONITOR.getBodyInfo(r),(s=r.SonarTarget)!=null&&s.isFound&&(I.setIsSonarTarget(!0),o=f.JS_NEXT)}switch(o){case f.JS_CONTINUE:break;case f.JS_NEXT:if(!this.mIsWaitChange){const r=[t,e,i],h=new a(a.CMD_CHANGE_SCENARIO,r);console.log("SCENARIOCONTROL->sendMessage"),window.SCENARIOCONTROL.sendMessage(h),this.mIsWaitChange=!0}break}}stop(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};c(m,"SW_TIMER",1),c(m,"SW_VAR",2),c(m,"SW_X",4),c(m,"SW_Y",8),c(m,"SW_COLOR",16),c(m,"SW_DIR",32),c(m,"SW_STAIR",64),c(m,"SW_DISTANCE",128),c(m,"SW_STOP",256),c(m,"SW_SYNC",512),c(m,"mSingleton",null);let y=m;window.NAVIGATOR=y.getInstance();class K{constructor(t=0,e=0){this.forward=t,this.turn=e}}class H{constructor(){}reset(){}getRunParameter(t,e){return isNaN(e.FWD)&&(e.FWD=0),isNaN(e.TRN)&&(e.TRN=0),new K(e.FWD,e.TRN)}}typeof window>"u"&&(global.window=global);class $ extends H{constructor(t){super(),this.mEdge=t,this.m_IntegVal=0}reset(){}getRunParameter(t,e){const i={forward:e.FWD,turn:0};let o={};if(window.STATUSMONITOR.getColorInfo(o),o.ColorSensorValue>750)return{forward:0,turn:0};const s=this.getProportional(e.KP,t,o,e),r=this.getIntegral(e.KI,s,o,e),h=this.getDifferential(e.KD,t,o,e);let u=s+r+h;return u=Math.max(-100,Math.min(100,u)),i.turn=i.forward===0?0:u,i}getProportional(t,e,i,o){const s=t,r=this.getLineColor(e),h=this.getOutColor(e),u=this.getThresholdOfTargetColor(r,h,o.WPER),w=r-h||1,p=i.ColorSensorValue,ot=this.mEdge==="LEFT"?u-p:p-u;let st=s*ot*10/w;return Math.max(-100,Math.min(100,st))}getThresholdOfTargetColor(t,e,i){return(t+e)/2-(t-e)*i/100}getIntegral(t,e,i,o){const s=t;if(o.NOBLNCE){let r=s*e/1e3+this.m_IntegVal;const h=e+this.m_IntegVal;return h>100?r=Math.max(0,100-e):h<-100&&(r=Math.min(0,-100-e)),this.m_IntegVal=Math.max(-100,Math.min(100,r)),this.m_IntegVal}else{let r=(i.diffSumChangeRateAryLast-i.diffSumChangeRateAry)/2*.004;return this.mEdge!=="LEFT"&&(r=-r),s*r/10}}getDifferential(t,e,i,o){const s=t,r=this.getLineColor(e)-this.getOutColor(e)||1;let h=i.diffSumChangeRateAry;return this.mEdge!=="LEFT"&&(h=-h),s*h*10/r}getLineColor(t){return t.mCalBlack}getOutColor(t){return t.mCalWhite}}typeof window>"u"&&(global.window=global);class Rt extends H{constructor(){super(),this.mHasPreDiff=!1,this.mBodyInfo={EncoderValue:{LEFT:0,RIGHT:0},sonarOn:0,GyroSenserValue:0,SonarValue:0,SonarTarget:{isFound:!1},BattyValue:0,TurnSpeed:0,RunSpeed:0}}getRunParameter(t,e){let i={};const o={forward:e.FWD,turn:0};window.STATUSMONITOR.getBodyInfo(i);const s=[0,0];let r=e.TRN;this.mHasPreDiff||(this.mBodyInfo.EncoderValue.LEFT=i.EncoderValue.LEFT,this.mBodyInfo.EncoderValue.RIGHT=i.EncoderValue.RIGHT,this.mHasPreDiff=!0),s.LEFT=i.EncoderValue.LEFT-this.mBodyInfo.EncoderValue.LEFT,s.RIGHT=i.EncoderValue.RIGHT-this.mBodyInfo.EncoderValue.RIGHT,r!==0&&(r>0?s.RIGHT=Math.floor(s.RIGHT*(1+r/100)):s.LEFT=Math.floor(s.LEFT*(1+-r/100)));const h=s.RIGHT-s.LEFT;return r+=h,o.turn=Math.max(-100,Math.min(100,r)),o}}typeof window>"u"&&(global.window=global);class Tt extends H{constructor(){super(),this.mTurn=0,this.mCount=0}getRunParameter(t,e){return e.TRN>0?this.mTurn<e.TRN&&(this.mTurn+=this.mCount++%3===0?1:0):this.mTurn>e.TRN&&(this.mTurn-=this.mCount++%3===0?1:0),new K(e.FWD,this.mTurn)}reset(){this.mTurn=0,this.mCount=0}}const Mt=1,Ot=2,Nt=3,At=5,P=[{type:Mt,runMethod:new $("LEFT")},{type:Ot,runMethod:new $("RIGHT")},{type:Nt,runMethod:new Tt},{type:At,runMethod:new Rt}];class pt{static factory(t){for(let e=0;e<P.length;e++)if(t===P[e].type)return P[e].runMethod;return null}}const Et=1,M=class M extends _{static getInstance(){return M.instance||(M.instance=new M(window.LEFTMOTOR,window.RIGHTMOTOR,window.ARMMOTOR)),M.instance}constructor(t,e,i){super(),this.motorL=t,this.motorR=e,this.armMotor=i,this.runMethod=null,this.msecCount=0,this.maxCount=0,this.gyroOffsetAdj2=0,this.blnceGyro=0,this.preNoneBalancer=0,this.commandSet={RunInfo:{}},this.calibrationInfo={},this.armCount=0,this.preFwd=0,this.preTurn=0,this.pwmL=0,this.pwmR=0,this.armOnly=!1}start(){console.log("RunCtrl start")}run(){const t=this.peekMessage();if(t)switch(t.getId()){case a.CMD_CHANGE_SCENARIO:this.commandSet=t.getData(),this.changeRunMethod();break}this.msecCount=this.msecCount===0?1:0,this.armOnly||this.controlRun(),this.controlArm()}changeRunMethod(){window.formData.setValue("sno",this.commandSet.SNO),window.formData.setValue("cno",this.commandSet.CNO),window.formData.setValue("fwd",this.commandSet.RunInfo.FWD),window.formData.setValue("trn",this.commandSet.RunInfo.TRN),console.log(`changeRun: FUNCNO=${this.commandSet.RunInfo.FUNCNO} FWD=${this.commandSet.RunInfo.FWD}`),this.runMethod=pt.factory(this.commandSet.RunInfo.FUNCNO),this.runMethod&&this.runMethod.reset(),this.armMotor.reset(),this.armCount=this.armMotor.getCount()}controlRun(){if(!this.runMethod){console.log("RunMethod ERROR");return}const t=this.runMethod.getRunParameter(this.calibrationInfo,this.commandSet.RunInfo);if(this.commandSet.RunInfo.NOBLNCE===0){if(this.preNoneBalancer===1&&window.STATUSMONITOR.resetMotor(),this.msecCount===0){const e={};window.STATUSMONITOR.getBodyInfo(e),this.blnceGyro=this.calibrationInfo.gyroOffset+this.commandSet.RunInfo.GYOFST+this.gyroOffsetAdj2,this.preFwd=t.forward,this.preTurn=t.turn}else if(this.preFwd===t.forward&&this.preTurn!==0){if(t.forward===0)this.pwmL=this.pwmL*t.turn/this.preTurn,this.pwmR=this.pwmR*t.turn/this.preTurn;else{const e=Math.abs(this.pwmL-this.pwmR)/2,i=e*t.turn/this.preTurn-e;this.pwmL+=i,this.pwmR-=i}this.pwmL=Math.max(-100,Math.min(100,this.pwmL)),this.pwmR=Math.max(-100,Math.min(100,this.pwmR))}}else if(this.commandSet.RunInfo.NOBLNCE===1){let e=t.forward+t.turn/2,i=t.forward-t.turn/2;e>100?(this.pwmL=100,this.pwmR=i-(e-100)):i>100?(this.pwmR=100,this.pwmL=e-(i-100)):(this.pwmL=e,this.pwmR=i),t.forward===0&&(this.pwmL=this.commandSet.RunInfo.TRN/2,this.pwmR=-this.commandSet.RunInfo.TRN/2),this.preFwd=t.forward,this.preTurn=t.turn}this.preNoneBalancer=this.commandSet.RunInfo.NOBLNCE,this.motorL.setPWM(this.pwmL),this.motorR.setPWM(this.pwmR),this.commandSet.RunInfo.SPFLG&Et?(this.gyroOffsetAdj2=-(this.pwmL+this.pwmR)*.2,this.gyroOffsetAdj2=Math.max(-20,Math.min(0,this.gyroOffsetAdj2))):this.gyroOffsetAdj2=0}controlArm(){if(!this.commandSet.RunInfo||!this.commandSet.RunInfo.ARMANG)return;const t=this.commandSet.RunInfo.ARMANG;if(t!==0){const e=this.armMotor.getCount()-this.armCount;let i=0;t>0?i=e<t?100:0:i=e>t?-100:0,this.armMotor.setPWM(i)}}stop(){}getRunConInfo(){return{SNO:this.commandSet.SNO,CNO:this.commandSet.CNO,fwd:this.preFwd,turn:this.preTurn,pwmL:this.pwmL,pwmR:this.pwmR,gyro:this.blnceGyro}}setCalibrationInfo(t){this.calibrationInfo={...t}}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};c(M,"instance",null);let v=M;const E=["Test","2025","2024"];class J{constructor(){this.yamlParser=null,this.loadYAMLParser()}async loadYAMLParser(){try{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js",t.onload=()=>{this.yamlParser=window.jsyaml,console.log("YAMLパーサーが読み込まれました")},document.head.appendChild(t)}catch(t){console.error("YAMLパーサーの読み込みに失敗しました:",t)}}parseYAML(t){if(!this.yamlParser)throw new Error("YAMLパーサーが読み込まれていません");try{return this.yamlParser.load(t)}catch(e){throw console.error("YAMLパースエラー:",e),new Error(`YAML設定ファイルのパースに失敗しました: ${e.message}`)}}async loadYAMLConfig(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const i=await e.text();return this.parseYAML(i)}catch(e){throw console.error(`YAML設定ファイル読み込みエラー (${t}):`,e),e}}async loadYAMLConfigs(t){const e={};for(const i of t)try{const o=i.split("/").pop().replace(".yaml","").replace(".yml","");e[o]=await this.loadYAMLConfig(i)}catch(o){console.warn(`YAML設定ファイル ${i} の読み込みをスキップしました:`,o)}return e}}class j{constructor(){this.configs=new Map,this.currentYear=E[E.length-1],this.loader=new J,this.isLoaded=!1}async initialize(){try{await this.waitForYAMLParser(),await this.loadAllConfigs(),this.isLoaded=!0,console.log("YAML設定の読み込みが完了しました")}catch(t){throw console.error("YAML設定の読み込みに失敗しました:",t),t}}async waitForYAMLParser(){return new Promise(t=>{const e=()=>{this.loader.yamlParser?t():setTimeout(e,100)};e()})}async loadAllConfigs(){for(const t of E)try{const e=await this.loadYearConfig(t);this.configs.set(t,e),console.log(`${t}年のYAML設定を読み込みました`)}catch(e){console.warn(`${t}年のYAML設定読み込みをスキップしました:`,e)}}async loadYearConfig(t){const e=[`config/${t}/robot.yaml`,`config/${t}/course.yaml`],i=await this.loader.loadYAMLConfigs(e);return{year:t,robot:i.robot||{},course:i.course||{},sensors:i.sensors||{},rules:i.rules||{}}}getCurrentConfig(){return this.getConfig(this.currentYear)}getConfig(t){if(!this.isLoaded)throw new Error("設定がまだ読み込まれていません。initialize()を先に呼び出してください。");const e=this.configs.get(t);if(e.imgpath=this.getPath(t)+e.course.image.filename,!e)throw new Error(`${t}年の設定が見つかりません`);return e}async setCurrentYear(t){if(!E.includes(t))throw new Error(`${t}年は利用可能な年度ではありません`);if(this.currentYear===t)return console.log(`既に${t}年が設定されています`),this.getCurrentConfig();if(!this.configs.has(t))try{const i=await this.loadYearConfig(t);this.configs.set(t,i),console.log(`${t}年のYAML設定を読み込みました`)}catch(i){throw new Error(`${t}年の設定読み込みに失敗しました: ${i.message}`)}const e=this.currentYear;return this.currentYear=t,console.log(`現在の年度を${e||"未設定"}年から${t}年に変更しました`),this.onYearChanged(t,e),this.getCurrentConfig()}onYearChanged(t,e){const i=new CustomEvent("yearChanged",{detail:{newYear:t,oldYear:e,config:this.getCurrentConfig()}});window.dispatchEvent(i)}getCurrentYear(){return this.currentYear}getAvailableYears(){return[...E]}getPath(t){return t===void 0&&(t=this.currentYear),`/sorot_spike_web_public/config/${t}/`}}window.YAMLConfigManager=j;window.YAMLConfigLoader=J;class X{constructor(t,e){this.name=t;const i=.5;this.scale=i,this.x=e.robot.initial_position.x,this.y=e.robot.initial_position.y,this.angle=e.robot.initial_position.angle*(Math.PI/180),this.width=e.robot.width*i,this.height=e.robot.height*i,this.wheelBase=e.robot.wheel.interval*i,this.wheelRadius=e.robot.wheel.radius*i,this.wheelWidth=5*i,this.leftPower=0,this.rightPower=0,this.maxSpeed=e.robot.speed.max_speed,this.color=e.robot.color,this.sensorColor=e.robot.sensorColor,this.wheelColor=e.robot.wheelColor,this.axleColor=e.robot.axleColor,this.sensor={r:0,g:0,b:0,brightness:0},this.status="idle",console.log(`${this.name} ロボットが起動しました。初期位置: (${this.x}, ${this.y})`)}move(t,e,i,o){const s=parseFloat(t),r=parseFloat(e);this.angle=i+o*(Math.PI/180);const h=(s+r)/2*this.maxSpeed/1e3;isNaN(h)||(this.x+=h*Math.cos(this.angle),this.y+=h*Math.sin(this.angle))}stop(){if(this.status==="idle"){console.log(`${this.name} は既に停止しています。`);return}console.log(`${this.name} が動作を停止しました。`),this.status="idle"}moveByVelocity(t,e,i){typeof t!="number"&&(t=0),typeof e!="number"&&(e=0),(typeof i!="number"||i<=0)&&(i=.1),this.angle+=e*i,this.x+=t*Math.cos(this.angle)*i,this.y+=t*Math.sin(this.angle)*i}getPose(){return{x:this.x,y:this.y,angle:this.angle}}getStatus(){return`${this.name} の現在の状態: ${this.status}, 位置: (${this.x}, ${this.y})`}}class Q{constructor(t){this.robot=t,this.isDragging=!1,this.animationId=null,this.pre=document.getElementById("outputContent"),this.canvas=document.getElementById("field"),this.pdfcanvas=document.getElementById("pdf"),this.trailcanvas=document.getElementById("trailCanvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.pdfctx=this.pdfcanvas.getContext("2d",{willReadFrequently:!0}),this.trailctx=this.trailcanvas.getContext("2d",{willReadFrequently:!0}),this.trail=[],this._setupEventListeners()}_setupEventListeners(){this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this._handleMouseUp.bind(this))}_handleMouseDown(t){const e=t.clientX-this.canvas.offsetLeft,i=t.clientY-this.canvas.offsetTop;if(Array.isArray(window.SCENARIO_MARKERS))for(let o=0;o<window.SCENARIO_MARKERS.length;o++){const s=window.SCENARIO_MARKERS[o],r=e-s.robot.x,h=i-s.robot.y,u=r*r+h*h,w=Math.max(this.robot.width,this.robot.height);if(u<=w*w){this._showMarkerInfo(s);return}}e>=this.robot.x-this.robot.width/2&&e<=this.robot.x+this.robot.width/2&&i>=this.robot.y-this.robot.height/2&&i<=this.robot.y+this.robot.height/2&&(this.isDragging=!0)}_showMarkerInfo(t){if(this.pre){const e=new Date(t.timestamp).toLocaleString(),i=t.timestamp%1e3;this.pre.innerHTML+=`Marker @ ${e} ${i}ms: `,this.pre.innerHTML+=`x=${t.robot.x}, y=${t.robot.y}, angle=${t.robot.angle}
`}else console.log("Marker",t)}_handleMouseMove(t){const e=t.clientX-this.canvas.offsetLeft,i=t.clientY-this.canvas.offsetTop;let o=!1;if(Array.isArray(window.SCENARIO_MARKERS))for(let s=0;s<window.SCENARIO_MARKERS.length;s++){const r=window.SCENARIO_MARKERS[s],h=e-r.robot.x,u=i-r.robot.y,w=h*h+u*u,p=Math.max(this.robot.width,this.robot.height);if(w<=p*p){o=!0;break}}this.canvas.style.cursor=o?"pointer":this.isDragging?"grabbing":"default",this.isDragging&&(this.robot.x=e,this.robot.y=i,this.draw())}_handleMouseUp(){this.isDragging=!1}inits(){this.drawBackground()}stopLoop(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null,console.log("CanvasManagerのアニメーションループを停止しました"))}isLoopRunning(){return this.animationId!==null}resumeLoop(){this.animationId===null&&(this.loop(),console.log("CanvasManagerのアニメーションループを再開しました"))}async loop(){this.updateRobot(),this.draw(),this.drawTrail();const t=this.getSensorColor(this.robot.x,this.robot.y,this.robot.angle),e=this.getSensorColor(this.robot.x+1,this.robot.y,this.robot.angle),i=Math.round((t.r+t.g+t.b)/3*70/255),o=Math.round((e.r+e.g+e.b)/3*70/255),s=(i+o)/2;this.robot.sensor={r:t.r,g:t.g,b:t.b,brightness:s};const r=`rgb(${Math.floor(t.r).toString().padStart(3,"0")},${Math.floor(t.g).toString().padStart(3,"0")},${Math.floor(t.b).toString().padStart(3,"0")})`;this.ctx.fillStyle=r,this.ctx.fillRect(10,30,20,20),this.ctx.fillStyle="black",this.ctx.font="16px sans-serif",this.ctx.fillText(`センサー色: ${r} (明度: ${s})`,10,20),this.trail.push({x:window.formData.getValue("xCoord"),y:window.formData.getValue("yCoord")}),this.animationId=requestAnimationFrame(this.loop.bind(this))}updateRobot(){if(window.LEFTMOTOR&&window.RIGHTMOTOR&&window.formData){const t=window.formData.getValue("leftPower"),e=window.formData.getValue("rightPower");let i={};window.STATUSMONITOR.getCoordinateInfo(i),console.log(`coordinate.driveDirection: ${i.driveDirection}`),this.robot.move(t,e,i.driveDirection,window.config.robot.initial_position.angle)}window.formData.renderRobot(this.robot)}drawBackground(){const t=window.configManager.getCurrentConfig().imgpath;pdfjsLib.getDocument(t).promise.then(i=>{console.log("PDF読み込み完了, ページ数:",i.numPages),i.getPage(1).then(o=>{const r=o.getViewport({scale:1});this.pdfcanvas.height=r.height,this.pdfcanvas.width=r.width/2;const h={canvasContext:this.pdfctx,viewport:r.clone({offsetX:0,offsetY:0})};o.render(h)})})}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.robot.x,this.robot.y),this.ctx.rotate(this.robot.angle),this.drawRobot(this.ctx,this.robot)}drawTrail(){if(!(this.trail.length<2)&&(this.trailctx.strokeStyle="rgb(255, 0, 0)",this.trailctx.lineWidth=2,this.trailctx.beginPath(),this.trail.length>1&&(this.trailctx.moveTo(this.trail[this.trail.length-2].x,this.trail[this.trail.length-2].y),this.trailctx.lineTo(this.trail[this.trail.length-1].x,this.trail[this.trail.length-1].y)),this.trailctx.stroke(),this.trailctx.closePath(),Array.isArray(window.SCENARIO_MARKERS)&&window.SCENARIO_MARKERS.length>0)){const t=window.SCENARIO_MARKERS[window.SCENARIO_MARKERS.length-1];t.isDraw||(t.isDraw=!0,this.trailctx.save(),this.trailctx.translate(t.robot.x,t.robot.y),this.trailctx.rotate(t.robot.angle),this.drawRobot(this.trailctx,t.robot),this.trailctx.fillStyle="black",this.trailctx.font="12px sans-serif",this.trailctx.fillText(`S:${t.commandSet.SNO} C:${t.commandSet.CNO}`,t.robot.x+20,t.robot.y-10))}}drawRobot(t,e){t.fillStyle=e.wheelColor,t.fillRect(-1*e.height,-1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillRect(-1*e.height,1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillStyle=e.axleColor,t.fillRect(-1*e.height/2,-1*e.width,5,e.wheelBase*2/3),t.fillStyle=e.color,t.beginPath(),t.fillRect(-e.height/2,-e.width/2,e.height,e.width),t.closePath(),t.fillStyle=e.sensorColor,t.beginPath(),t.arc(e.height/2,0,3,0,Math.PI*2),t.fill(),t.closePath(),t.restore()}getSensorColor(t,e,i){let o=t+Math.cos(i)*(this.robot.width/2),s=e+Math.sin(i)*(this.robot.width/2)+5;o=Math.floor(this.pdfcanvas.width/this.canvas.width*o),s=Math.floor(this.pdfcanvas.height/this.canvas.height*s);const r=this.pdfctx.getImageData(o,s,1,1).data;return{r:r[0],g:r[1],b:r[2]}}reset(){this.stopLoop(),this.trail=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.trailctx.clearRect(0,0,this.trailcanvas.width,this.trailcanvas.height),console.log("CanvasManagerをリセットしました")}clearTrail(){this.trail=[],this.trailctx.clearRect(0,0,this.trailcanvas.width,this.trailcanvas.height),console.log("軌跡をクリアしました")}}class z{constructor(){}initializeScenarioData(t){return Array.isArray(t)?t.map(e=>{const i={...e};return i.RunInfo||(i.RunInfo={}),isNaN(i.RunInfo.FUNCNO)&&(i.RunInfo.FUNCNO=0),isNaN(i.RunInfo.FWD)&&(i.RunInfo.FWD=0),isNaN(i.RunInfo.TRN)&&(i.RunInfo.TRN=0),isNaN(i.RunInfo.KP)&&(i.RunInfo.KP=0),isNaN(i.RunInfo.KI)&&(i.RunInfo.KI=0),isNaN(i.RunInfo.KD)&&(i.RunInfo.KD=0),isNaN(i.RunInfo.NOBLNCE)&&(i.RunInfo.NOBLNCE=0),isNaN(i.RunInfo.WPER)&&(i.RunInfo.WPER=0),i.SwitchInfo||(i.SwitchInfo={}),isNaN(i.SwitchInfo.SCJFN)&&(i.SwitchInfo.SCJFN=0),isNaN(i.SwitchInfo.SCT)&&(i.SwitchInfo.SCT=0),isNaN(i.SwitchInfo.SCD)&&(i.SwitchInfo.SCD=0),isNaN(i.SwitchInfo.SCR)&&(i.SwitchInfo.SCR=0),isNaN(i.SwitchInfo.SCC)&&(i.SwitchInfo.SCC=0),isNaN(i.SwitchInfo.SCV)&&(i.SwitchInfo.SCV=0),isNaN(i.SwitchInfo.JMPSNO)&&(i.SwitchInfo.JMPSNO=0),isNaN(i.SwitchInfo.SCX)&&(i.SwitchInfo.SCX=0),isNaN(i.SwitchInfo.SCY)&&(i.SwitchInfo.SCY=0),i.CoordCorrectInfo||(i.CoordCorrectInfo={}),i}):(console.warn("シナリオデータが配列ではありません。初期化をスキップします。",t),t)}async loadScenarioFromUrl(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTPエラー! ステータス: ${e.status} (${t})`);const i=await e.text();return this.loadScenarioFromText(i)}catch(e){throw console.error(`シナリオデータ (${t}) の読み込みまたはパース中にエラーが発生しました:`,e),e}}loadScenarioFromText(t){try{let e=JSON.parse(t);return e=this.initializeScenarioData(e),console.log("シナリオデータ（初期化後）:",e),e}catch(e){throw console.error("JSONテキストのパース中にエラーが発生しました:",e),e}}}class Dt{constructor(t){this.formId=t}setValue(t,e){const i=document.getElementById(t);i?isNaN(e)?i.value=e:i.value=Math.round(e):console.warn(`Field with ID ${t} not found.`)}getValue(t){const e=document.getElementById(t);return e?e.value:null}renderCoordinate(t){try{this.setValue("distance",t.distance),this.setValue("x",t.x),this.setValue("y",t.y),this.setValue("angle2",t.driveDirection*180/Math.PI)}catch(e){console.error("renderCoordinate failed",e)}}renderRobot(t){this.setValue("xCoord",t.x),this.setValue("yCoord",t.y),this.setValue("angle",t.angle*180/Math.PI)}}let O=null,k;document.addEventListener("DOMContentLoaded",function(){O=document.getElementById("outputContent"),k=document.getElementById("field"),k.getContext("2d",{willReadFrequently:!0})});const N=5;let A=null;async function q(){console.log(`navigator
`);const n=y.getInstance();for(;;)n.run(),await new Promise(t=>setTimeout(t,10))}async function Z(){console.log(`status_monitor_task
`);const n=L.getInstance();for(;;){n.run(),await new Promise(e=>setTimeout(e,10));const t={};window.STATUSMONITOR.getCoordinateInfo(t),window.formData.renderCoordinate(t)}}async function V(){console.log(`scenario_control_task
`);const n=b.getInstance();for(;;)n.run(),await new Promise(t=>setTimeout(t,10))}async function tt(){console.log("sorot"),window.SOROT.run()}async function et(){console.log(`run_control_task
`);const n=v.getInstance();for(;;)n.run(),await new Promise(t=>setTimeout(t,10))}async function it(){await new Promise(t=>setTimeout(t,1e3));let n={};for(window.SOROT.initialize(),bt(n),await new Promise(t=>setTimeout(t,1e3)),O.innerHTML+=`シナリオ読み込み開始
`,Lt(n),V(),await new Promise(t=>setTimeout(t,1e3));;){if(SCENARIOCONTROL.mSubScenarioList.length>0){for(let t of SCENARIOCONTROL.mSubScenarioList[0].mArrCommandSet)O.innerHTML+=`ScenaIN ${t.SNO} ${t.CNO}
`;break}await new Promise(t=>setTimeout(t,1e3))}O.innerHTML+=`シナリオが読み込み完了
`,yt(n),await new Promise(t=>setTimeout(t,1e3)),await new Promise(t=>setTimeout(t,1e3))}async function bt(n,t){let e=0,i;return n.cmdID=a.CMD_INIT,e=N,window.SOROT.setStatus(I.Idle),i=new a(n.cmdID,n.data,0),window.SOROT.sendMessage(i),e}async function Lt(n,t){let e=0,i,o=0;console.log(`dummy loadScenario
`),console.log(`loadScenario Sorot::Idle
`),console.log("読み込み");for(let r=0;r<A.length;r++)n.cmdID=a.CMD_INSERT_SCENARIO,n.data=A[r],i=new a(n.cmdID,n.data,N),console.log(`SCENARIOCONTROL->sendMessage: ${n.cmdID}`),window.SCENARIOCONTROL.sendMessage(i);n.cmdID=a.CMD_INSERT_SUB_LIST,e=N,i=new a(n.cmdID,n.data,0),console.log(`SCENARIOCONTROL->sendMessage: ${n.cmdID}`),window.SCENARIOCONTROL.sendMessage(i);const s=new Array(1);for(s[0]=24,o=0;o<s.length;o++)n.data[o]=s[o],console.log(`LOAD ${o}: ${s[o]}`);return console.log("読み込み完了"),n.cmdID=a.CMD_INSERT_SCN_LIST,e=N+o,i=new a(n.cmdID,n.data,e),console.log(`SCENARIOCONTROL->sendMessage: ${n.cmdID}`),window.SCENARIOCONTROL.sendMessage(i),window.SOROT.setStatus(I.Downloaded),e}async function yt(n){let t=0,e;return n.cmdID=a.CMD_START_CALIB,t=N,window.SOROT.setStatus(I.Calibrating),e=new a(n.cmdID,n.data,0),console.log("SOROT->sendMessage"),window.SOROT.doCalibration(e),t}async function nt(){await new Promise(t=>setTimeout(t,1e3)),_t({}),await new Promise(t=>setTimeout(t,1e3))}async function _t(n,t){let e=0,i;return console.log("dummy readyToStart 217"),n.cmdID=a.CMD_START,n.data={0:0,1:0},e=N+2,window.SOROT.setStatus(I.Running),i=new a(n.cmdID,n.data,2),console.log("SOROT->sendMessage"),window.SOROT.sendMessage(i),e}async function B(){const n=window.formData.getValue("scenarioInput");try{A=await new z().loadScenarioFromText(n),console.log("シナリオデータ（初期化後）:",A)}catch(t){console.error(`JSONの解析中にエラーが発生しました: ${t.message} (位置: ${t.position})`),O.innerHTML+=`無効なJSON形式です。
`;return}await Promise.all([V(),it()])}async function Y(){window.robot.x=d.robot.init.x,window.robot.y=d.robot.init.y,window.robot.angle=d.robot.init.angle,Promise.all([tt()]),await Promise.all([q(),et(),Z(),nt()])}async function W(){let n;try{const i=await fetch(d.config.robot.scenario.unittest_url);if(!i.ok)throw new Error(`HTTPエラー! ステータス: ${i.status} (${url})`);n=await i.text()}catch(i){throw console.error(`シナリオデータ (${url}) の読み込みまたはパース中にエラーが発生しました:`,i),i}let t=JSON.parse(n);const e=new z;if(Array.isArray(t)){console.log(`単体テスト用に複数のシナリオ (${t.length}個) が読み込まれました。各シナリオを順次確認します。`);for(const[i,o]of t.entries()){A=e.initializeScenarioData(t[i]),window.formData.setValue("scenarioInput",JSON.stringify(A,null,4)),Promise.all([V(),it()]),await new Promise(u=>setTimeout(u,3e3)),window.robot.x=d.robot.init.x,window.robot.y=d.robot.init.y,window.robot.angle=d.robot.init.angle;const s=new g("leftPower"),r=new g("rightPower");window.LEFTMOTOR=s,window.RIGHTMOTOR=r;const h=new U(s,r);window.HWMONITOR=h,Promise.all([tt(),q(),et(),Z(),nt()]),await new Promise(u=>setTimeout(u,1e4)),window.SCENARIOCONTROL.clearScenario(),window.SCENARIOCONTROL.mScnNoListIndex=0,window.SCENARIOCONTROL.mSubScenarioList=[]}}}document.addEventListener("DOMContentLoaded",async()=>{const n=new j;await n.initialize(),window.configManager=n;const t=n.getCurrentConfig(),e=new X("robot",t);e.init={...e};const i=new Q(e);i.inits(),i.loop();const o=n.getPath()+t.robot.scenario.url,s=await fetch(o).then(r=>r.text());d.formData.setValue("scenarioInput",s),d.robot=e,d.config=t,d.gWhite=t.robot.sensors.color.white_threshold,d.gBlack=t.robot.sensors.color.black_threshold,d.canvasManager=i,d.SOROT=new I(1),d.RUNCONTROL=v.getInstance(),d.STATUSMONITOR=L.getInstance(),d.SCENARIOCONTROL=b.getInstance(),d.NAVIGATOR=y.getInstance(),d.SCENARIO_MARKERS=[],d.RCVHEADERSIZE=N,xt()});const d=typeof window<"u"?window:globalThis;d.load=typeof B<"u"?B:void 0;d.main=typeof Y<"u"?Y:void 0;d.runUnitTest=typeof W<"u"?W:void 0;d.formData=new Dt("");document.addEventListener("DOMContentLoaded",function(){O=document.getElementById("outputContent"),document.getElementById("loadScenarioButton").addEventListener("click",function(){typeof window.load=="function"&&window.load()}),document.getElementById("startRunButton").addEventListener("click",function(){O.innerHTML+=`走行を開始します。
`,typeof window.main=="function"&&window.main()}),document.getElementById("startUnitTestButton").addEventListener("click",function(){typeof window.main=="function"&&window.runUnitTest()})});function xt(){var i,o;const n=document.getElementById("yearSelect");if(!n){console.warn("年度選択プルダウンが見つかりません");return}n.removeEventListener("change",n._changeHandler);const t=(i=window.configManager)==null?void 0:i.getAvailableYears();n.innerHTML="";const e=(o=window.configManager)==null?void 0:o.getCurrentYear();e&&(n.value=e),t.forEach(s=>{const r=document.createElement("option");r.value=s,r.textContent=`${s}`,s===e&&(r.selected=!0),n.appendChild(r)}),n._changeHandler=async function(){const s=this.value;if(s&&window.configManager)try{console.log(`年度を${s}年に変更中...`),await window.configManager.setCurrentYear(s),console.log(`年度を${s}年に変更しました`)}catch(r){console.error("年度の変更に失敗しました:",r),alert(`年度の変更に失敗しました: ${r.message}`),this.value=window.configManager.getCurrentYear()||""}},n.addEventListener("change",n._changeHandler)}window.addEventListener("yearChanged",async function(n){const{newYear:t,oldYear:e,config:i}=n.detail;await vt(t)});async function vt(n,t){try{window.canvasManager&&window.canvasManager.stopLoop(),d.configManager.setCurrentYear(n);const e=window.configManager.getCurrentConfig(),i=new X("robot",e);i.init={...i};const o=new Q(i);o.inits(),o.loop();const s=configManager.getPath()+e.robot.scenario.url,r=await fetch(s).then(h=>h.text());d.formData.setValue("scenarioInput",r),d.robot=i,d.config=e,d.gWhite=e.robot.sensors.color.white_threshold,d.gBlack=e.robot.sensors.color.black_threshold,d.canvasManager=o,window.canvasManager=o}catch(e){console.error("UI更新中にエラーが発生しました:",e)}}
