var z=Object.defineProperty;var j=(o,t,e)=>t in o?z(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var l=(o,t,e)=>j(o,typeof t!="symbol"?t+"":t,e);import{d as D,e as q,M as r,f as Z,C as Q,H as Y,a as p,S as N,R as $,b as k}from"./robot-eg90LYBI.js";const C=class C{constructor(){this.mArrCommandSet=[],this.mIndex=0}clear(){this.mArrCommandSet=[]}insertCommandSet(t){for(let e=0;e<this.mArrCommandSet.length;e++){const n=this.mArrCommandSet[e];if(n.SNO===t.SNO&&n.CNO===t.CNO)return this.mArrCommandSet.splice(e,1,t),C.UPDATE;if(n.SNO===t.PRVSNO&&n.CNO===t.PRVCNO)return this.mArrCommandSet.splice(e+1,0,t),C.INSERT}return this.mArrCommandSet.push(t),C.ADD}getCommandSet(){return this.mIndex<this.mArrCommandSet.length?this.mArrCommandSet[this.mIndex]:null}searchCommandSet(t,e){for(let n=0;n<this.mArrCommandSet.length;n++){const i=this.mArrCommandSet[n];if(i.SNO===t&&i.CNO===e)return this.mIndex=n,!0}return!1}getRecordCount(){return this.mArrCommandSet.length}moveFirst(){this.mIndex=0}moveNext(){this.mIndex++}};l(C,"INSERT",0),l(C,"UPDATE",1),l(C,"ADD",2);let T=C;const u=class u extends D{constructor(){super(),this.mScenario=new T,this.mIsSync=!1,this.mSubScenarioList=[],this.mSubScnListIndex=0,this.mScenarioNoList=[],this.mScnNoListIndex=0}start(){console.log("ScenarioCtrl start")}run(){let t=this.peekMessage();if(t!==null){switch(q(`ScenarioCtrl run. :${t.getId()}`),t.getId()){case r.CMD_CLEAR_SCENARIO:console.log("CMD_CLEAR_SCENARIO"),this.clearScenario(t);break;case r.CMD_INSERT_SCENARIO:console.log("CMD_INSERT_SCENARIO"),this.insertScenario(t);break;case r.CMD_START_CALIB:console.log("CMD_START_CALIB"),this.preStartScenario();break;case r.CMD_START:console.log("CMD_START"),this.nextScenario(t,!0);break;case r.CMD_STOP:console.log("CMD_STOP"),this.stopScenario(t);break;case r.CMD_CHANGE_SCENARIO:console.log("CMD_CHANGE_SCENARIO"),this.nextScenario(t,!1);break;case r.CMD_SYNC:console.log("CMD_SYNC"),this.mIsSync=!0;break;case r.CMD_INSERT_SUB_LIST:console.log("CMD_INSERT_SUB_LIST"),this.insertSubScenarioList();break;case r.CMD_INSERT_SCN_LIST:console.log("CMD_INSERT_SCN_LIST"),this.insertScenarioNoList(t);break}t=null}}clearScenario(t){this.mScenario=new T}insertScenario(t){let e=t.getData();this.mScenario.insertCommandSet(e),console.log(`ScenaIN ${e.SNO} ${e.CNO}`)}insertSubScenarioList(){this.mSubScenarioList.push(this.mScenario),this.mScenario=new T}insertScenarioNoList(t){console.log("insertScenarioNoList 開始");let e=t.getData(),n=t.getDataLength()-RCVHEADERSIZE;for(let i=0;i<n;i++)this.mScenarioNoList.push(e[i]),console.log(`ScnNo:${i} ${e[i]}`);console.log("insertScenarioNoList 完了")}preStartScenario(){console.log("preStartScenario 開始");let t={},e;this.mScenario=this.mSubScenarioList[0],this.mScenario&&(t=this.mScenario.getCommandSet(),console.log(`${this.constructor.name} ${t.SNO} ${t.CNO}`),e=new r(r.CMD_CHANGE_SCENARIO,t),window.RUNCONTROL.sendMessage(e),e=new r(r.CMD_CHANGE_SCENARIO,t),window.NAVIGATOR.sendMessage(e),console.log("preStartScenario 完了"))}stopScenario(t){}nextScenario(t,e){let n={},i,s=t.getData();if(e){if(s[0]===0&&s[1]===0)this.mScenario.moveFirst();else if(!this.mScenario.searchCommandSet(s[0],s[1])){console.log(`ScenaNG ${s[0]} ${s[1]}`);return}}else if(s[0]===1)this.mScenario.moveNext();else if(!this.mScenario.searchCommandSet(s[1],s[2])){console.log(`ScenaNG ${s[0]} ${s[1]}`);return}if(Z("ScenarioControl::nextScenario 1"),this.IsEndScenario())if(this.mScnNoListIndex++,this.mScnNoListIndex<this.mScenarioNoList.length)this.mScenario=this.mSubScenarioList[this.mScenarioNoList[this.mScnNoListIndex]],this.mScenario.moveFirst(),console.log(`ScnNo:${this.mScenarioNoList[this.mScnNoListIndex]}`);else{COMMANDDISPATCHER.sendResponse(t,r.ERR_OK);return}n=this.mScenario.getCommandSet(),console.log(`SNO:${n.SNO} CNO:${n.CNO}`);try{const g={SNO:this.mScenario.getCommandSet().SNO,CNO:this.mScenario.getCommandSet().CNO,timestamp:Date.now(),robot:JSON.parse(JSON.stringify(window.robot)),isDraw:!1,commandSet:JSON.parse(JSON.stringify(n))};Array.isArray(window.SCENARIO_MARKERS)||(window.SCENARIO_MARKERS=[]),window.SCENARIO_MARKERS.push(g)}catch(g){console.warn("Failed to capture marker",g)}n.CoordCorrectInfo.ACAF>0&&(i=new r(r.CMD_CORRECT_COORDINF,n.CoordCorrectInfo),window.STATUSMONITOR.sendMessage(i));let a=u.OFF;n.RunInfo.SONAR&&(a=u.ON),i=new r(r.CMD_SONARSENSOR,a),window.STATUSMONITOR.sendMessage(i),i=new r(r.CMD_CHANGE_SCENARIO,n),window.RUNCONTROL.sendMessage(i),i=new r(r.CMD_CHANGE_SCENARIO,n),window.NAVIGATOR.sendMessage(i),e&&(window.RUNCONTROL.ArmOnly=!1)}IsEndScenario(){return this.mScenario.getCommandSet().SNO===0&&this.mScenario.getCommandSet().CNO===0}static getInstance(){return u.mSingleton==null&&(u.mSingleton=new u),u.mSingleton}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};l(u,"mSingleton",null),l(u,"OFF",!1),l(u,"ON",!0);let A=u;window.SCENARIOCONTROL=A.getInstance();const tt="leftPower",et="rightPower",c=class c extends D{constructor(t){super(),this.taskId=t,this.isSonarTarget=!1,c.mStatus=c.Initial,c.mArmMotor=new N("c"),c.mRightMotor=new N(et),c.mLeftMotor=new N(tt),c.mHWMonitor=new Y(c.mLeftMotor,c.mRightMotor),window.COLORMONITOR=c.getColorMonitor(),window.HWMONITOR=c.getHWMonitor(),window.STATUSMONITOR=p.getInstance(),window.ARMMOTOR=c.getArmMotor(),window.RIGHTMOTOR=c.getRightMotor(),window.LEFTMOTOR=c.getLeftMotor()}async run(){let t=!1;console.log("wait sorot getMessage");let e;for(;;){if(e=this.getMessage(),e==null){await new Promise(n=>setTimeout(n,4));continue}switch(console.log(`SorotRcv: ${e.getId()}`),e.getId()){case r.CMD_INIT:console.log("Message.CMD_INIT"),this.setStatus(c.Idle);break;case r.CMD_SET_SOROTINFO:console.log("Message.CMD_SET_SOROTINFO"),this.setRunControlParam(e);break;case r.CMD_SET_INDIVIDUAL:console.log("Message.CMD_SET_INDIVIDUAL"),this.setIndividualParam(e);break;case r.CMD_START_CALIB:console.log("Message.CMD_START_CALIB"),await this.doCalibration(e),this.getCalibrationInfo(e),this.setStatus(c.Ready);break;case r.CMD_GET_CALIBINFO:console.log("Message.CMD_GET_CALIBINFO"),this.getCalibrationInfo(e);break;case r.CMD_START:console.log("Message.CMD_START"),this.setStatus(c.Running),this.startRun(e),t=!0;break}if(e=null,t)break}}initialize(){c.mArmMotor.setPWM(30),setTimeout(()=>{c.mArmMotor.setPWM(0),c.mArmMotor.reset()},600)}async doCalibration(t){window.RUNCONTROL.ArmOnly=!0,window.RUNCONTROL.start(),console.log("START CALIB");const e=gBlack,n=gWhite;console.log(gBlack);const i=Math.floor((e+n)/2);this.mCalInfo={mCalBlack:e,mCalGray:i,mCalWhite:n,mGyroOffset:0},window.RUNCONTROL.setCalibrationInfo(this.mCalInfo),window.NAVIGATOR.setCalibrationInfo(this.mCalInfo);const s=new r(t.getId(),t.getData(),t.getDataLength());window.SCENARIOCONTROL.sendMessage(s)}getCalibrationInfo(t){}startRun(t){const e=new r(t.getId(),t.getData(),t.getDataLength());window.STATUSMONITOR.start(),window.NAVIGATOR.start(),window.SCENARIOCONTROL.sendMessage(e)}setRunControlParam(t){const e=t.getData();A_D=e.A_D,A_R=e.A_R,K_F=[e.K_F0,e.K_F1,e.K_F2,e.K_F3],K_I=e.K_I,K_PHIDOT=e.K_PHIDOT,K_THETADOT=e.K_THETADOT}setIndividualParam(t){}setStatus(t){c.mStatus=t}getStatus(){return c.mStatus}static getColorMonitor(){return c.mColorMonitor}static getArmMotor(){return c.mArmMotor}static getRightMotor(){return c.mRightMotor}static getLeftMotor(){return c.mLeftMotor}static getHWMonitor(){return c.mHWMonitor}static getCalibration(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};l(c,"Initial",0),l(c,"Idle",1),l(c,"Downloaded",2),l(c,"Calibrating",3),l(c,"Ready",4),l(c,"Running",5),l(c,"Goal",6),l(c,"Retire",7),l(c,"mLCD",{}),l(c,"mArmMotor"),l(c,"mRightMotor"),l(c,"mLeftMotor"),l(c,"mColorMonitor",new Q("C")),l(c,"mHWMonitor"),l(c,"mStatus");let f=c;const S=class S{constructor(){this.m_LostCnt=0,this.m_pCaribInfo}IsLost(){return!1}GetStatus(){let t=S.JS_CONTINUE;return this.IsLost()?t=S.JS_LOST:this.IsChange()&&(t=S.JS_NEXT),t}IsChange(){return!1}SetCaribrationInfo(t){this.m_pCaribInfo=t}};l(S,"JS_CONTINUE",0),l(S,"JS_LOST",1),l(S,"JS_NEXT",2),l(S,"JS_RETURN",3);let w=S;typeof window>"u"&&(global.window=global);class nt extends w{constructor(){super(),this.m_PassageTime=0,this.m_startTime=Date.now(),this.m_clock={now:()=>Date.now()-this.m_startTime,reset:()=>{this.m_startTime=Date.now()}}}IsChange(){return this.m_clock.now()>this.m_PassageTime}Init(t){this.m_PassageTime=t.SwitchInfo.SCT}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class ot extends w{constructor(){super(),this.m_VarType=0}IsChange(){let t=!1;switch(this.m_VarType){case 0:t=!0;break;case 1:t=window.SOROT.getIsSwitchFlg();break}return t}Init(t){this.m_VarType=t.SwitchInfo.SCV}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class it extends w{constructor(){super(),this.m_naname=!1,this.m_targetColor=null}IsChange(){return this.getColorInfo().color===this.m_targetColor}Init(t){this.m_naname=t.RunInfo.NOBLNCE===1,this.m_targetColor=t.SwitchInfo.SCC}getColorInfo(){const t={};return window.STATUSMONITOR.getColorInfo(t),t}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class st extends w{constructor(){super(),this.m_PreDiff=0,this.m_TargetDir=0}IsChange(){let t;const e={};window.STATUSMONITOR.getCoordinateInfo(e),t=this.m_TargetDir-e.driveDirection;const n=this.m_PreDiff*t<=0;return this.m_PreDiff=t,n}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_TargetDir=t.SwitchInfo.SCR*(Math.PI/180)+e.driveDirection,this.m_PreDiff=this.m_TargetDir-e.driveDirection}setCalibrationInfo(t){super.setCalibrationInfo(t)}GetStatus(){return super.GetStatus()}}typeof window>"u"&&(global.window=global);class at extends w{constructor(){super(),this.m_startDistance=0,this.preDistance=0,this.m_distance=0}Init(t){const e={};window.STATUSMONITOR.getCoordinateInfo(e),this.m_startDistance=e.distance,this.preDistance=0,this.m_distance=t.SwitchInfo.SCD}IsChange(){const t={};window.STATUSMONITOR.getCoordinateInfo(t);const e=t.distance-this.m_startDistance;let n=!1;return this.m_distance>0?e>this.m_distance&&(n=!0):this.m_distance<0?e<this.m_distance&&(n=!0):(this.preDistance>0&&e<=0||this.preDistance<0&&e>=0)&&(n=!0),this.preDistance=e,n}setCalibrationInfo(t){super.SetCaribrationInfo(t)}GetStatus(){return super.GetStatus()}}const d=class d extends D{constructor(){super(),this.taskPriority=3,this.mIsWaitChange=!1,this.m_CommandSet={},this.m_calibInfo={},this.m_switchMethodTbl=[{bit:d.SW_TIMER,switchMethod:new nt},{bit:d.SW_VAR,switchMethod:new ot},{bit:d.SW_COLOR,switchMethod:new it},{bit:d.SW_DIR,switchMethod:new st},{bit:d.SW_DISTANCE,switchMethod:new at}]}static getInstance(){return d.mSingleton||(d.mSingleton=new d),d.mSingleton}setCalibrationInfo(t){this.m_calibInfo=t}start(){}run(){const t=this.peekMessage();t&&t.getId()===r.CMD_CHANGE_SCENARIO&&(this.m_CommandSet=t.getData(),this.changeSwitchMethod(),this.mIsWaitChange=!1),window.SOROT.getStatus()===f.Running&&this.navigatorRun()}changeSwitchMethod(){if(this.m_CommandSet.SNO!=="END_SCENARIO")for(const t of this.m_switchMethodTbl)this.m_CommandSet.SwitchInfo.SCJFN&t.bit&&(t.switchMethod.Init(this.m_CommandSet),t.switchMethod.SetCaribrationInfo(this.m_calibInfo))}navigatorRun(){var s;let t=1,e=0,n=0,i=w.JS_CONTINUE;for(const a of this.m_switchMethodTbl)if(this.m_CommandSet.SwitchInfo.SCJFN&a.bit){if(i=a.switchMethod.GetStatus(),a.bit===w.SW_VAR){i===w.JS_NEXT&&(t=2,e=this.m_CommandSet.SwitchInfo.JMPSNO,n=1),i=w.JS_NEXT;break}if(i!==w.JS_CONTINUE)break}if(this.m_CommandSet.RunInfo.SONAR){let a;window.STATUSMONITOR.getBodyInfo(a),(s=a.SonarTarget)!=null&&s.isFound&&(f.setIsSonarTarget(!0),i=w.JS_NEXT)}switch(i){case w.JS_CONTINUE:break;case w.JS_NEXT:if(!this.mIsWaitChange){const a=[t,e,n],g=new r(r.CMD_CHANGE_SCENARIO,a);console.log("SCENARIOCONTROL->sendMessage"),window.SCENARIOCONTROL.sendMessage(g),this.mIsWaitChange=!0}break}}stop(){}peekMessage(){return super.peekMessage()}getMessage(){return super.getMessage()}sendMessage(t){super.sendMessage(t)}};l(d,"SW_TIMER",1),l(d,"SW_VAR",2),l(d,"SW_X",4),l(d,"SW_Y",8),l(d,"SW_COLOR",16),l(d,"SW_DIR",32),l(d,"SW_STAIR",64),l(d,"SW_DISTANCE",128),l(d,"SW_STOP",256),l(d,"SW_SYNC",512),l(d,"mSingleton",null);let b=d;window.NAVIGATOR=b.getInstance();const O=["Test","2025","2024"];class F{constructor(){this.yamlParser=null,this.loadYAMLParser()}async loadYAMLParser(){try{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js",t.onload=()=>{this.yamlParser=window.jsyaml,console.log("YAMLパーサーが読み込まれました")},document.head.appendChild(t)}catch(t){console.error("YAMLパーサーの読み込みに失敗しました:",t)}}parseYAML(t){if(!this.yamlParser)throw new Error("YAMLパーサーが読み込まれていません");try{return this.yamlParser.load(t)}catch(e){throw console.error("YAMLパースエラー:",e),new Error(`YAML設定ファイルのパースに失敗しました: ${e.message}`)}}async loadYAMLConfig(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.text();return this.parseYAML(n)}catch(e){throw console.error(`YAML設定ファイル読み込みエラー (${t}):`,e),e}}async loadYAMLConfigs(t){const e={};for(const n of t)try{const i=n.split("/").pop().replace(".yaml","").replace(".yml","");e[i]=await this.loadYAMLConfig(n)}catch(i){console.warn(`YAML設定ファイル ${n} の読み込みをスキップしました:`,i)}return e}}class U{constructor(){this.configs=new Map,this.currentYear=O[O.length-1],this.loader=new F,this.isLoaded=!1}async initialize(){try{await this.waitForYAMLParser(),await this.loadAllConfigs(),this.isLoaded=!0,console.log("YAML設定の読み込みが完了しました")}catch(t){throw console.error("YAML設定の読み込みに失敗しました:",t),t}}async waitForYAMLParser(){return new Promise(t=>{const e=()=>{this.loader.yamlParser?t():setTimeout(e,100)};e()})}async loadAllConfigs(){for(const t of O)try{const e=await this.loadYearConfig(t);this.configs.set(t,e),console.log(`${t}年のYAML設定を読み込みました`)}catch(e){console.warn(`${t}年のYAML設定読み込みをスキップしました:`,e)}}async loadYearConfig(t){const e=[`config/${t}/robot.yaml`,`config/${t}/course.yaml`],n=await this.loader.loadYAMLConfigs(e);return{year:t,robot:n.robot||{},course:n.course||{},sensors:n.sensors||{},rules:n.rules||{}}}getCurrentConfig(){return this.getConfig(this.currentYear)}getConfig(t){if(!this.isLoaded)throw new Error("設定がまだ読み込まれていません。initialize()を先に呼び出してください。");const e=this.configs.get(t);if(e.imgpath=this.getPath(t)+e.course.image.filename,!e)throw new Error(`${t}年の設定が見つかりません`);return e}async setCurrentYear(t){if(!O.includes(t))throw new Error(`${t}年は利用可能な年度ではありません`);if(this.currentYear===t)return console.log(`既に${t}年が設定されています`),this.getCurrentConfig();if(!this.configs.has(t))try{const n=await this.loadYearConfig(t);this.configs.set(t,n),console.log(`${t}年のYAML設定を読み込みました`)}catch(n){throw new Error(`${t}年の設定読み込みに失敗しました: ${n.message}`)}const e=this.currentYear;return this.currentYear=t,console.log(`現在の年度を${e||"未設定"}年から${t}年に変更しました`),this.onYearChanged(t,e),this.getCurrentConfig()}onYearChanged(t,e){const n=new CustomEvent("yearChanged",{detail:{newYear:t,oldYear:e,config:this.getCurrentConfig()}});window.dispatchEvent(n)}getCurrentYear(){return this.currentYear}getAvailableYears(){return[...O]}getPath(t){return t===void 0&&(t=this.currentYear),`/sorot_spike_web_public/config/${t}/`}}window.YAMLConfigManager=U;window.YAMLConfigLoader=F;class H{constructor(t){this.robot=t,this.isDragging=!1,this.animationId=null,this.pre=document.getElementById("outputContent"),this.canvas=document.getElementById("field"),this.pdfcanvas=document.getElementById("pdf"),this.trailcanvas=document.getElementById("trailCanvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.pdfctx=this.pdfcanvas.getContext("2d",{willReadFrequently:!0}),this.trailctx=this.trailcanvas.getContext("2d",{willReadFrequently:!0}),this.trail=[],this._setupEventListeners()}_setupEventListeners(){this.canvas.addEventListener("mousedown",this._handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this._handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this._handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this._handleMouseUp.bind(this))}_handleMouseDown(t){const e=t.clientX-this.canvas.offsetLeft,n=t.clientY-this.canvas.offsetTop;if(Array.isArray(window.SCENARIO_MARKERS))for(let i=0;i<window.SCENARIO_MARKERS.length;i++){const s=window.SCENARIO_MARKERS[i],a=e-s.robot.x,g=n-s.robot.y,m=a*a+g*g,E=Math.max(this.robot.width,this.robot.height);if(m<=E*E){this._showMarkerInfo(s);return}}e>=this.robot.x-this.robot.width/2&&e<=this.robot.x+this.robot.width/2&&n>=this.robot.y-this.robot.height/2&&n<=this.robot.y+this.robot.height/2&&(this.isDragging=!0)}_showMarkerInfo(t){if(this.pre){const e=new Date(t.timestamp).toLocaleString(),n=t.timestamp%1e3;this.pre.innerHTML+=`Marker @ ${e} ${n}ms: `,this.pre.innerHTML+=`x=${t.robot.x}, y=${t.robot.y}, angle=${t.robot.angle}
`}else console.log("Marker",t)}_handleMouseMove(t){const e=t.clientX-this.canvas.offsetLeft,n=t.clientY-this.canvas.offsetTop;let i=!1;if(Array.isArray(window.SCENARIO_MARKERS))for(let s=0;s<window.SCENARIO_MARKERS.length;s++){const a=window.SCENARIO_MARKERS[s],g=e-a.robot.x,m=n-a.robot.y,E=g*g+m*m,y=Math.max(this.robot.width,this.robot.height);if(E<=y*y){i=!0;break}}this.canvas.style.cursor=i?"pointer":this.isDragging?"grabbing":"default",this.isDragging&&(this.robot.x=e,this.robot.y=n,this.draw())}_handleMouseUp(){this.isDragging=!1}inits(){this.drawBackground()}stopLoop(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null,console.log("CanvasManagerのアニメーションループを停止しました"))}isLoopRunning(){return this.animationId!==null}resumeLoop(){this.animationId===null&&(this.loop(),console.log("CanvasManagerのアニメーションループを再開しました"))}async loop(){this.updateRobot(),this.draw(),this.drawTrail();const t=this.getSensorColor(this.robot.x,this.robot.y,this.robot.angle),e=this.getSensorColor(this.robot.x+1,this.robot.y,this.robot.angle),n=Math.round((t.r+t.g+t.b)/3*70/255),i=Math.round((e.r+e.g+e.b)/3*70/255),s=(n+i)/2;this.robot.sensor={r:t.r,g:t.g,b:t.b,brightness:s};const a=`rgb(${Math.floor(t.r).toString().padStart(3,"0")},${Math.floor(t.g).toString().padStart(3,"0")},${Math.floor(t.b).toString().padStart(3,"0")})`;this.ctx.fillStyle=a,this.ctx.fillRect(10,30,20,20),this.ctx.fillStyle="black",this.ctx.font="16px sans-serif",this.ctx.fillText(`センサー色: ${a} (明度: ${s})`,10,20),this.trail.push({x:window.formData.getValue("xCoord"),y:window.formData.getValue("yCoord")}),this.animationId=requestAnimationFrame(this.loop.bind(this))}updateRobot(){if(window.LEFTMOTOR&&window.RIGHTMOTOR&&window.formData){const t=window.formData.getValue("leftPower"),e=window.formData.getValue("rightPower");let n={};window.STATUSMONITOR.getCoordinateInfo(n),console.log(`coordinate.driveDirection: ${n.driveDirection}`),this.robot.move(t,e,n.driveDirection,window.config.robot.initial_position.angle)}window.formData.renderRobot(this.robot)}drawBackground(){const t=window.configManager.getCurrentConfig().imgpath;pdfjsLib.getDocument(t).promise.then(n=>{console.log("PDF読み込み完了, ページ数:",n.numPages),n.getPage(1).then(i=>{const a=i.getViewport({scale:1});this.pdfcanvas.height=a.height,this.pdfcanvas.width=a.width/2;const g={canvasContext:this.pdfctx,viewport:a.clone({offsetX:0,offsetY:0})};i.render(g)})})}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.robot.x,this.robot.y),this.ctx.rotate(this.robot.angle),this.drawRobot(this.ctx,this.robot)}drawTrail(){if(!(this.trail.length<2)&&(this.trailctx.strokeStyle="rgb(255, 0, 0)",this.trailctx.lineWidth=2,this.trailctx.beginPath(),this.trail.length>1&&(this.trailctx.moveTo(this.trail[this.trail.length-2].x,this.trail[this.trail.length-2].y),this.trailctx.lineTo(this.trail[this.trail.length-1].x,this.trail[this.trail.length-1].y)),this.trailctx.stroke(),this.trailctx.closePath(),Array.isArray(window.SCENARIO_MARKERS)&&window.SCENARIO_MARKERS.length>0)){const t=window.SCENARIO_MARKERS[window.SCENARIO_MARKERS.length-1];t.isDraw||(t.isDraw=!0,this.trailctx.save(),this.trailctx.translate(t.robot.x,t.robot.y),this.trailctx.rotate(t.robot.angle),this.drawRobot(this.trailctx,t.robot),this.trailctx.fillStyle="black",this.trailctx.font="12px sans-serif",this.trailctx.fillText(`S:${t.commandSet.SNO} C:${t.commandSet.CNO}`,t.robot.x+20,t.robot.y-10))}}drawRobot(t,e){t.fillStyle=e.wheelColor,t.fillRect(-1*e.height,-1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillRect(-1*e.height,1*e.width,e.wheelRadius*2,e.wheelWidth*1.5),t.fillStyle=e.axleColor,t.fillRect(-1*e.height/2,-1*e.width,5,e.wheelBase*2/3),t.fillStyle=e.color,t.beginPath(),t.fillRect(-e.height/2,-e.width/2,e.height,e.width),t.closePath(),t.fillStyle=e.sensorColor,t.beginPath(),t.arc(e.height/2,0,3,0,Math.PI*2),t.fill(),t.closePath(),t.restore()}getSensorColor(t,e,n){let i=t+Math.cos(n)*(this.robot.width/2),s=e+Math.sin(n)*(this.robot.width/2)+5;i=Math.floor(this.pdfcanvas.width/this.canvas.width*i),s=Math.floor(this.pdfcanvas.height/this.canvas.height*s);const a=this.pdfctx.getImageData(i,s,1,1).data;return{r:a[0],g:a[1],b:a[2]}}reset(){this.stopLoop(),this.trail=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.trailctx.clearRect(0,0,this.trailcanvas.width,this.trailcanvas.height),console.log("CanvasManagerをリセットしました")}clearTrail(){this.trail=[],this.trailctx.clearRect(0,0,this.trailcanvas.width,this.trailcanvas.height),console.log("軌跡をクリアしました")}}class V{constructor(){}initializeScenarioData(t){return Array.isArray(t)?t.map(e=>{const n={...e};return n.RunInfo||(n.RunInfo={}),isNaN(n.RunInfo.FUNCNO)&&(n.RunInfo.FUNCNO=0),isNaN(n.RunInfo.FWD)&&(n.RunInfo.FWD=0),isNaN(n.RunInfo.TRN)&&(n.RunInfo.TRN=0),isNaN(n.RunInfo.KP)&&(n.RunInfo.KP=0),isNaN(n.RunInfo.KI)&&(n.RunInfo.KI=0),isNaN(n.RunInfo.KD)&&(n.RunInfo.KD=0),isNaN(n.RunInfo.NOBLNCE)&&(n.RunInfo.NOBLNCE=0),isNaN(n.RunInfo.WPER)&&(n.RunInfo.WPER=0),n.SwitchInfo||(n.SwitchInfo={}),isNaN(n.SwitchInfo.SCJFN)&&(n.SwitchInfo.SCJFN=0),isNaN(n.SwitchInfo.SCT)&&(n.SwitchInfo.SCT=0),isNaN(n.SwitchInfo.SCD)&&(n.SwitchInfo.SCD=0),isNaN(n.SwitchInfo.SCR)&&(n.SwitchInfo.SCR=0),isNaN(n.SwitchInfo.SCC)&&(n.SwitchInfo.SCC=0),isNaN(n.SwitchInfo.SCV)&&(n.SwitchInfo.SCV=0),isNaN(n.SwitchInfo.JMPSNO)&&(n.SwitchInfo.JMPSNO=0),isNaN(n.SwitchInfo.SCX)&&(n.SwitchInfo.SCX=0),isNaN(n.SwitchInfo.SCY)&&(n.SwitchInfo.SCY=0),n.CoordCorrectInfo||(n.CoordCorrectInfo={}),n}):(console.warn("シナリオデータが配列ではありません。初期化をスキップします。",t),t)}async loadScenarioFromUrl(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTPエラー! ステータス: ${e.status} (${t})`);const n=await e.text();return this.loadScenarioFromText(n)}catch(e){throw console.error(`シナリオデータ (${t}) の読み込みまたはパース中にエラーが発生しました:`,e),e}}loadScenarioFromText(t){try{let e=JSON.parse(t);return e=this.initializeScenarioData(e),console.log("シナリオデータ（初期化後）:",e),e}catch(e){throw console.error("JSONテキストのパース中にエラーが発生しました:",e),e}}}class rt{constructor(t){this.formId=t}setValue(t,e){const n=document.getElementById(t);n?isNaN(e)?n.value=e:n.value=Math.round(e):console.warn(`Field with ID ${t} not found.`)}getValue(t){const e=document.getElementById(t);return e?e.value:null}renderCoordinate(t){try{this.setValue("distance",t.distance),this.setValue("x",t.x),this.setValue("y",t.y),this.setValue("angle2",t.driveDirection*180/Math.PI)}catch(e){console.error("renderCoordinate failed",e)}}renderRobot(t){this.setValue("xCoord",t.x),this.setValue("yCoord",t.y),this.setValue("angle",t.angle*180/Math.PI)}}let I=null,_;document.addEventListener("DOMContentLoaded",function(){I=document.getElementById("outputContent"),_=document.getElementById("field"),_.getContext("2d",{willReadFrequently:!0})});const M=5;let R=null;async function B(){console.log(`navigator
`);const o=b.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function W(){console.log(`status_monitor_task
`);const o=p.getInstance();for(;;){o.run(),await new Promise(e=>setTimeout(e,10));const t={};window.STATUSMONITOR.getCoordinateInfo(t),window.formData.renderCoordinate(t)}}async function L(){console.log(`scenario_control_task
`);const o=A.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function G(){console.log("sorot"),window.SOROT.run()}async function J(){console.log(`run_control_task
`);const o=k.getInstance();for(;;)o.run(),await new Promise(t=>setTimeout(t,10))}async function K(){await new Promise(t=>setTimeout(t,1e3));let o={};for(window.SOROT.initialize(),ct(o),await new Promise(t=>setTimeout(t,1e3)),I.innerHTML+=`シナリオ読み込み開始
`,lt(o),L(),await new Promise(t=>setTimeout(t,1e3));;){if(SCENARIOCONTROL.mSubScenarioList.length>0){for(let t of SCENARIOCONTROL.mSubScenarioList[0].mArrCommandSet)I.innerHTML+=`ScenaIN ${t.SNO} ${t.CNO}
`;break}await new Promise(t=>setTimeout(t,1e3))}I.innerHTML+=`シナリオが読み込み完了
`,ht(o),await new Promise(t=>setTimeout(t,1e3)),await new Promise(t=>setTimeout(t,1e3))}async function ct(o,t){let e=0,n;return o.cmdID=r.CMD_INIT,e=M,window.SOROT.setStatus(f.Idle),n=new r(o.cmdID,o.data,0),window.SOROT.sendMessage(n),e}async function lt(o,t){let e=0,n,i=0;console.log(`dummy loadScenario
`),console.log(`loadScenario Sorot::Idle
`),console.log("読み込み");for(let a=0;a<R.length;a++)o.cmdID=r.CMD_INSERT_SCENARIO,o.data=R[a],n=new r(o.cmdID,o.data,M),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(n);o.cmdID=r.CMD_INSERT_SUB_LIST,e=M,n=new r(o.cmdID,o.data,0),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(n);const s=new Array(1);for(s[0]=24,i=0;i<s.length;i++)o.data[i]=s[i],console.log(`LOAD ${i}: ${s[i]}`);return console.log("読み込み完了"),o.cmdID=r.CMD_INSERT_SCN_LIST,e=M+i,n=new r(o.cmdID,o.data,e),console.log(`SCENARIOCONTROL->sendMessage: ${o.cmdID}`),window.SCENARIOCONTROL.sendMessage(n),window.SOROT.setStatus(f.Downloaded),e}async function ht(o){let t=0,e;return o.cmdID=r.CMD_START_CALIB,t=M,window.SOROT.setStatus(f.Calibrating),e=new r(o.cmdID,o.data,0),console.log("SOROT->sendMessage"),window.SOROT.doCalibration(e),t}async function X(){await new Promise(t=>setTimeout(t,1e3)),dt({}),await new Promise(t=>setTimeout(t,1e3))}async function dt(o,t){let e=0,n;return console.log("dummy readyToStart 217"),o.cmdID=r.CMD_START,o.data={0:0,1:0},e=M+2,window.SOROT.setStatus(f.Running),n=new r(o.cmdID,o.data,2),console.log("SOROT->sendMessage"),window.SOROT.sendMessage(n),e}async function x(){const o=window.formData.getValue("scenarioInput");try{R=await new V().loadScenarioFromText(o),console.log("シナリオデータ（初期化後）:",R)}catch(t){console.error(`JSONの解析中にエラーが発生しました: ${t.message} (位置: ${t.position})`),I.innerHTML+=`無効なJSON形式です。
`;return}await Promise.all([L(),K()])}async function P(){window.robot.x=h.robot.init.x,window.robot.y=h.robot.init.y,window.robot.angle=h.robot.init.angle,Promise.all([G()]),await Promise.all([B(),J(),W(),X()])}async function v(){let o;try{const n=await fetch(h.config.robot.scenario.unittest_url);if(!n.ok)throw new Error(`HTTPエラー! ステータス: ${n.status} (${url})`);o=await n.text()}catch(n){throw console.error(`シナリオデータ (${url}) の読み込みまたはパース中にエラーが発生しました:`,n),n}let t=JSON.parse(o);const e=new V;if(Array.isArray(t)){console.log(`単体テスト用に複数のシナリオ (${t.length}個) が読み込まれました。各シナリオを順次確認します。`);for(const[n,i]of t.entries()){R=e.initializeScenarioData(t[n]),window.formData.setValue("scenarioInput",JSON.stringify(R,null,4)),Promise.all([L(),K()]),await new Promise(m=>setTimeout(m,3e3)),window.robot.x=h.robot.init.x,window.robot.y=h.robot.init.y,window.robot.angle=h.robot.init.angle;const s=new N("leftPower"),a=new N("rightPower");window.LEFTMOTOR=s,window.RIGHTMOTOR=a;const g=new Y(s,a);window.HWMONITOR=g,Promise.all([G(),B(),J(),W(),X()]),await new Promise(m=>setTimeout(m,1e4)),window.SCENARIOCONTROL.clearScenario(),window.SCENARIOCONTROL.mScnNoListIndex=0,window.SCENARIOCONTROL.mSubScenarioList=[]}}}document.addEventListener("DOMContentLoaded",async()=>{const o=new U;await o.initialize(),window.configManager=o;const t=o.getCurrentConfig(),e=new $("robot",t);e.init={...e};const n=new H(e);n.inits(),n.loop();const i=o.getPath()+t.robot.scenario.url,s=await fetch(i).then(a=>a.text());h.formData.setValue("scenarioInput",s),h.robot=e,h.config=t,h.gWhite=t.robot.sensors.color.white_threshold,h.gBlack=t.robot.sensors.color.black_threshold,h.canvasManager=n,h.SOROT=new f(1),h.RUNCONTROL=k.getInstance(),h.STATUSMONITOR=p.getInstance(),h.SCENARIOCONTROL=A.getInstance(),h.NAVIGATOR=b.getInstance(),h.SCENARIO_MARKERS=[],h.RCVHEADERSIZE=M,gt()});const h=typeof window<"u"?window:globalThis;h.load=typeof x<"u"?x:void 0;h.main=typeof P<"u"?P:void 0;h.runUnitTest=typeof v<"u"?v:void 0;h.formData=new rt("");document.addEventListener("DOMContentLoaded",function(){I=document.getElementById("outputContent"),document.getElementById("loadScenarioButton").addEventListener("click",function(){typeof window.load=="function"&&window.load()}),document.getElementById("startRunButton").addEventListener("click",function(){I.innerHTML+=`走行を開始します。
`,typeof window.main=="function"&&window.main()}),document.getElementById("startUnitTestButton").addEventListener("click",function(){typeof window.main=="function"&&window.runUnitTest()})});function gt(){var n,i;const o=document.getElementById("yearSelect");if(!o){console.warn("年度選択プルダウンが見つかりません");return}o.removeEventListener("change",o._changeHandler);const t=(n=window.configManager)==null?void 0:n.getAvailableYears();o.innerHTML="";const e=(i=window.configManager)==null?void 0:i.getCurrentYear();e&&(o.value=e),t.forEach(s=>{const a=document.createElement("option");a.value=s,a.textContent=`${s}`,s===e&&(a.selected=!0),o.appendChild(a)}),o._changeHandler=async function(){const s=this.value;if(s&&window.configManager)try{console.log(`年度を${s}年に変更中...`),await window.configManager.setCurrentYear(s),console.log(`年度を${s}年に変更しました`)}catch(a){console.error("年度の変更に失敗しました:",a),alert(`年度の変更に失敗しました: ${a.message}`),this.value=window.configManager.getCurrentYear()||""}},o.addEventListener("change",o._changeHandler)}window.addEventListener("yearChanged",async function(o){const{newYear:t,oldYear:e,config:n}=o.detail;await wt(t)});async function wt(o,t){try{window.canvasManager&&window.canvasManager.stopLoop(),h.configManager.setCurrentYear(o);const e=window.configManager.getCurrentConfig(),n=new $("robot",e);n.init={...n};const i=new H(n);i.inits(),i.loop();const s=configManager.getPath()+e.robot.scenario.url,a=await fetch(s).then(g=>g.text());h.formData.setValue("scenarioInput",a),h.robot=n,h.config=e,h.gWhite=e.robot.sensors.color.white_threshold,h.gBlack=e.robot.sensors.color.black_threshold,h.canvasManager=i,window.canvasManager=i}catch(e){console.error("UI更新中にエラーが発生しました:",e)}}
